<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBGS Pride Pass</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png"
        href="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/236ecf96-a881-428d-9213-83d1c7313131/dkeifgy-9ff321c6-6ecc-45a8-8bab-23c6948a37fb.png?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7InBhdGgiOiJcL2ZcLzIzNmVjZjk2LWE4ODEtNDI4ZC05MjEzLTgzZDFjNzMxMzEzMVwvZGtlaWZneS05ZmYzMjFjNi02ZWNjLTQ1YTgtOGJhYi0yM2M2OTQ4YTM3ZmIucG5nIn1dXSwiYXVkIjpbInVybjpzZXJ2aWNlOmZpbGUuZG93bmxvYWQiXX0.VJGuojZj4NXBuMknJXQ2PmAAensLWE7pi2M7oFMWcfg">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- QR Code generation library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>

    <!-- QR Code scanning library -->
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <!-- Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- AlpineJS for UI interactions -->
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>

    <style>
        /* Custom font and base styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        #app {
            position: relative;
            z-index: 1;
        }

        .pride-gradient-bg {
            background: linear-gradient(135deg, #6B21A8, #BE185D, #F59E0B);
        }

        .pride-gradient-text {
            background: linear-gradient(135deg, #8B5CF6, #EC4899, #FBBF24);
            -webkit-background-clip: text;
            background-clip: text;
            /* Standard property for compatibility */
            -webkit-text-fill-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }

        @keyframes fadeInItem {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-item {
            animation: fadeInItem 0.5s ease-out forwards;
        }


        /* --- Theme Styles --- */

        /* Default Theme */
        body.theme-default {
            background-color: #111827;
        }

        body.theme-default #app {
            background-color: #1f2937;
            color: #f9fafb;
            background-image: url('https://i.pinimg.com/736x/da/97/9f/da979f580fe467231df9411605f2e3eb.jpg');
            background-size: cover;
            background-position: center;

        }

        body.theme-default .bg-gray-700 {
            background-color: #37415198;
        }

        body.theme-default .bg-gray-800 {
            background-color: #1f2937;
        }

        body.theme-default .bg-gray-900 {
            background-color: #111827;
        }

        body.theme-default .bg-gray-900\/50 {
            background-color: rgba(17, 24, 39, 0.5);
        }

        body.theme-default .text-gray-300 {
            color: #d1d5db;
        }

        body.theme-default .text-gray-400 {
            color: #9ca3af;
        }

        body.theme-rainbow #video-background-container {
            display: block;
        }

        body.theme-rainbow #app {
            background-color: rgba(0, 0, 0, 0.6);
            background-image: url('https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/236ecf96-a881-428d-9213-83d1c7313131/dkdu4if-1aed848a-3318-4cb9-af9f-338013f9960c.gif?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7InBhdGgiOiJcL2ZcLzIzNmVjZjk2LWE4ODEtNDI4ZC05MjEzLTgzZDFjNzMxMzEzMVwvZGtkdTRpZi0xYWVkODQ4YS0zMzE4LTRjYjktYWY5Zi0zMzgwMTNmOTk2MGMuZ2lmIn1dXSwiYXVkIjpbInVybjpzZXJ2aWNlOmZpbGUuZG93bmxvYWQiXX0.S-HYO2Nr6J8r2MPfGhoVfsXFuFnuIgjkCK1Ed-4ZtzM');
            background-size: cover;
            background-position: center;
            /* Dark overlay for readability */
        }

        body.theme-rainbow .pride-gradient-bg,
        body.theme-rainbow .accent-pink-500 {
            background: linear-gradient(135deg, red, orange, yellow, green, blue, indigo, violet);
            accent-color: violet;
        }

        body.theme-rainbow .pride-gradient-text,
        body.theme-rainbow .text-pink-400,
        body.theme-rainbow .text-purple-400,
        body.theme-rainbow .text-amber-400,
        body.theme-rainbow .text-green-400,
        body.theme-rainbow .text-red-400,
        body.theme-rainbow .text-blue-400 {
            background: linear-gradient(135deg, red, orange, yellow, green, blue, indigo, violet);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        body.theme-rainbow .border-pink-500,
        body.theme-rainbow .border-purple-500 {
            border-image: linear-gradient(135deg, red, orange, yellow, green, blue, indigo, violet) 1;
        }

        /* Rainbow-Linear Overrides */
        body.theme-rainbow2 {
            background: linear-gradient(45deg,#ff00b3, #0084ff, #0099ff);
            background-size: 400% 400%;
            animation: rainbow-bg 15s ease infinite;
        }

        @keyframes rainbow-bg {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        body.theme-rainbow2 #app {
            background: linear-gradient(45deg, #ff00b3, #0084ff, #0099ff);
            background-size: 400% 100%;
            animation: rainbow-bg 15s ease infinite;
            /* background-size: cover;
            background-position: center; */
        }

        body.theme-rainbow2 #app-header,
        body.theme-rainbow2 #app-nav,
        body.theme-rainbow2 .modal-fade-in,
        body.theme-rainbow2 .bg-gray-900\/50,
        body.theme-rainbow2 .bg-gray-700,
        body.theme-rainbow2 .bg-gray-800,
        body.theme-rainbow2 .bg-gray-900 {
            background-color: #000000 !important;
        }

        body.theme-rainbow2 .text-white {
            color: #ffffff !important;
        }

        body.theme-rainbow2 .text-gray-300,
        body.theme-rainbow2 .text-gray-400 {
            color: #ffffff !important;
        }

        body.theme-rainbow2 .pride-gradient-text,
        body.theme-rainbow2 .text-pink-400,
        body.theme-rainbow2 .text-purple-400,
        body.theme-rainbow2 .text-amber-400,
        body.theme-rainbow2 .text-green-400,
        body.theme-rainbow2 .text-red-400,
        body.theme-rainbow2 .text-blue-400 {
            color: #ffffff !important;
            background: none;
            -webkit-text-fill-color: unset;
        }

        body.theme-rainbow2 .pride-gradient-bg,
        body.theme-rainbow2 .accent-pink-500 {
            background: #474747 !important;
            accent-color: #ad8500;
        }

        body.theme-rainbow2 .border-pink-500,
        body.theme-rainbow2 .border-purple-500 {
            border-color: #f048ff !important;
        }



        /* Light Theme Overrides */
        body.theme-light {
            background-color: #e5e7eb !important;
        }

        body.theme-light #app {
            background-color: #f3f4f6 !important;
            background-image: url('https://i.pinimg.com/736x/89/27/30/89273078173e894d00701aee921cdaea.jpg');
            color: #272300 !important;
            background-size: cover;
            background-position: center;
        }

        body.theme-light #app-header,
        body.theme-light #app-nav,
        body.theme-light .modal-fade-in,
        body.theme-light .bg-gray-900\/50,
        body.theme-light .bg-gray-700,
        body.theme-light .bg-gray-800,
        body.theme-light .bg-gray-900 {
            background-color: #e5e7eb !important;
        }

        body.theme-light .text-white {
            color: #302f00 !important;
        }

        body.theme-light .text-gray-300,
        body.theme-light .text-gray-400 {
            color: #585700 !important;
        }

        body.theme-light .pride-gradient-text,
        body.theme-light .text-pink-400,
        body.theme-light .text-purple-400,
        body.theme-light .text-amber-400,
        body.theme-light .text-green-400,
        body.theme-light .text-red-400,
        body.theme-light .text-blue-400 {
            color: #ad8500 !important;
            background: none;
            -webkit-text-fill-color: unset;
        }

        body.theme-light .pride-gradient-bg,
        body.theme-light .accent-pink-500 {
            background: #ad8500 !important;
            accent-color: #ad8500;
        }

        body.theme-light .border-pink-500,
        body.theme-light .border-purple-500 {
            border-color: #ad8500 !important;
        }


        /* Blue Theme Overrides */
        body.theme-blue {
            background-color: #1e3a8a !important;
        }

        body.theme-blue #app {
            background-color: #1e3a8a !important;
            background-image: url(' https://i.pinimg.com/1200x/46/fb/a9/46fba9944f3af578a9d831bbe7971deb.jpg');
            color: #ffffff !important;
            background-size: cover;
            background-position: center;
        }

        body.theme-blue #app-header,
        body.theme-blue #app-nav,
        body.theme-blue .modal-fade-in,
        body.theme-blue .bg-gray-900\/50,
        body.theme-blue .bg-gray-700,
        body.theme-blue .bg-gray-800,
        body.theme-blue .bg-gray-900 {
            background-color: #1e40af !important;
        }

        body.theme-blue .text-white {
            color: #eff6ff !important;
        }

        body.theme-blue .text-gray-300,
        body.theme-blue .text-gray-400 {
            color: #dbeafe !important;
        }

        body.theme-blue .pride-gradient-text,
        body.theme-blue .text-pink-400,
        body.theme-blue .text-purple-400,
        body.theme-blue .text-amber-400,
        body.theme-blue .text-green-400,
        body.theme-blue .text-red-400,
        body.theme-blue .text-blue-400 {
            color: #60a5fa !important;
            background: none;
            -webkit-text-fill-color: unset;
        }

        body.theme-blue .pride-gradient-bg,
        body.theme-blue .accent-pink-500 {
            background: #60a5fa !important;
            accent-color: #60a5fa;
        }

        body.theme-blue .border-pink-500,
        body.theme-blue .border-purple-500 {
            border-color: #60a5fa !important;
        }

        /* Green Theme Overrides */
        body.theme-green {
            background-color: #064e3b !important;
           
        }

        body.theme-green #app {
             background-image: url('  https://i.pinimg.com/736x/87/3d/90/873d90d90227a19d005d6c9c74de8d76.jpg');
            background-color: #064e3b !important;
            color: #ecfdf5 !important;
        }

        body.theme-green #app-header,
        body.theme-green #app-nav,
        body.theme-green .modal-fade-in,
        body.theme-green .bg-gray-900\/50,
        body.theme-green .bg-gray-700,
        body.theme-green .bg-gray-800,
        body.theme-green .bg-gray-900 {
            background-color: #0a2e16 !important;
        }

        body.theme-green .text-white {
            color: #ecfdf5 !important;
        }

        body.theme-green .text-gray-300,
        body.theme-green .text-gray-400 {
            color: #d1fae5 !important;
        }

        body.theme-green .pride-gradient-text,
        body.theme-green .text-pink-400,
        body.theme-green .text-purple-400,
        body.theme-green .text-amber-400,
        body.theme-green .text-green-400,
        body.theme-green .text-red-400,
        body.theme-green .text-blue-400 {
            color: #5cff6a !important;
            background: none;
            -webkit-text-fill-color: unset;
        }

        body.theme-green .pride-gradient-bg,
        body.theme-green .accent-pink-500 {
            background: #00d435 !important;
            accent-color: #00ff55;
        }

        body.theme-green .border-pink-500,
        body.theme-green .border-purple-500 {
            border-color: #00f351 !important;
        }

        /* Pink Theme Overrides */
        body.theme-pink {
            background-color: #8318439a !important;
        }

        body.theme-pink #app {
            color: #fce7f3 !important;
            background-color: #d12a6d !important;
            color: #fce7f3 !important;
            background-image: url(' https://i.pinimg.com/736x/69/38/e4/6938e42485cf0eaf14ac0e9848fd0e0f.jpg');
            background-size: cover;
            background-position: center;
        }

        body.theme-pink #app-header,
        body.theme-pink #app-nav,
        body.theme-pink .modal-fade-in,
        body.theme-pink .bg-gray-900\/50,
        body.theme-pink .bg-gray-700,
        body.theme-pink .bg-gray-800,
        body.theme-pink .bg-gray-900 {
            background-color: #9d174dbb !important;
        }

        body.theme-pink .text-white {
            color: #fce7f3 !important;
        }

        body.theme-pink .text-gray-300,
        body.theme-pink .text-gray-400 {
            color: #fbcfe8 !important;
        }

        body.theme-pink .pride-gradient-text,
        body.theme-pink .text-pink-400,
        body.theme-pink .text-purple-400,
        body.theme-pink .text-amber-400,
        body.theme-pink .text-green-400,
        body.theme-pink .text-red-400,
        body.theme-pink .text-blue-400 {
            color: #f472b6 !important;
            background: none;
            -webkit-text-fill-color: unset;
        }

        body.theme-pink .pride-gradient-bg,
        body.theme-pink .accent-pink-500 {
            background: #f472b6 !important;
            accent-color: #f472b6;
        }

        body.theme-pink .border-pink-500,
        body.theme-pink .border-purple-500 {
            border-color: #f472b6 !important;
        }
    </style>
</head>

<body class="bg-gray-900 text-white antialiased">
    <div id="video-background-container"></div>
    <div id="app" class="max-w-lg mx-auto min-h-screen bg-gray-800 shadow-2xl flex flex-col">
        <!-- Loading Spinner -->
        <div id="loading-overlay" class="absolute inset-0 bg-gray-800 z-50 flex flex-col items-center justify-center">
            <img src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/236ecf96-a881-428d-9213-83d1c7313131/dkd5vnt-9b2c83cb-9a07-4833-9bf0-c8f73ef3509e.png/v1/fill/w_894,h_894/bbgs_logo_by_titoycute_dkd5vnt-pre.png?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7ImhlaWdodCI6Ijw9MTI4MCIsInBhdGgiOiJcL2ZcLzIzNmVjZjk2LWE4ODEtNDI4ZC05MjEzLTgzZDFjNzMxMzEzMVwvZGtkNXZudC05YjJjODNjYi05YTA3LTQ4MzMtOWJmMC1jOGY3M2VmMzUwOWUucG5nIiwid2lkdGgiOiI8PTEyODAifV1dLCJhdWQiOlsidXJuOnNlcnZpY2U6aW1hZ2Uub3BlcmF0aW9ucyJdfQ.UwsCveUIwpaz7Z9bnrH8M757Oy8GnnGis0NP32nmdYU"
                alt="BBGS Logo" class="w-24 h-24 rounded-2xl mb-4 animate-pulse">
            <p id="loading-text" class="text-gray-400">Connecting to Pride Pass...</p>
        </div>

        <!-- Header -->
        <header id="app-header"
            class="p-4 flex justify-between items-center bg-gray-900/50 backdrop-blur-sm sticky top-0 z-20 hidden">
            <div class="flex items-center space-x-3">
                <img src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/236ecf96-a881-428d-9213-83d1c7313131/dkeifgy-9ff321c6-6ecc-45a8-8bab-23c6948a37fb.png/v1/fill/w_894,h_894,q_70,strp/qr_code_by_titoycute_dkeifgy-pre.jpg?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7ImhlaWdodCI6Ijw9MTAyNCIsInBhdGgiOiJcL2ZcLzIzNmVjZjk2LWE4ODEtNDI4ZC05MjEzLTgzZDFjNzMxMzEzMVwvZGtlaWZneS05ZmYzMjFjNi02ZWNjLTQ1YTgtOGJhYi0yM2M2OTQ4YTM3ZmIucG5nIiwid2lkdGgiOiI8PTEwMjQifV1dLCJhdWQiOlsidXJuOnNlcnZpY2U6aW1hZ2Uub3BlcmF0aW9ucyJdfQ.CHZ1gwHO3Mkj9JF9n8FWXChZ_Mf2nDj-xde0wsmynkU"
                    onerror="this.onerror=null;this.src='https://placehold.co/64x64/BE185D/FFFFFF?text=BBGS';"
                    alt="BBGS Logo" class="w-10 h-10 rounded-lg object-cover">
                <h1 class="text-xl font-bold pride-gradient-text">Pride Pass</h1>
            </div>
            <div x-data="{ open: false }" class="relative">
                <button @click="open = !open" class="flex items-center space-x-2">
                    <div class="text-right">
                        <p id="user-name-header" class="font-semibold text-sm"></p>
                        <p id="user-points-header" class="text-xs text-amber-400 font-bold"></p>
                    </div>
                    <i data-lucide="user-round-cog" class="w-8 h-8"></i>
                </button>
                <div x-show="open" @click.away="open = false"
                    class="absolute right-0 mt-2 w-48 bg-gray-700 rounded-lg shadow-xl z-50" style="display: none;">
                    <a href="#" onclick="event.preventDefault(); app.navigateTo('profile')"
                        class="flex items-center px-4 py-2  text-white hover:bg-gray-600"><i data-lucide="user-circle"
                            class="w-4 h-4 mr-2"></i>My Profile</a>
                    <a href="#" onclick="event.preventDefault(); app.navigateTo('badges')"
                        class="flex items-center px-4 py-2 text-l text-white hover:bg-gray-600"><i data-lucide="award"
                            class="w-4 h-4 mr-2"></i>My Badges</a>
                    <a href="#" onclick="event.preventDefault(); app.navigateTo('directory')"
                        class="flex items-center px-4 py-2 text-l text-white hover:bg-gray-600"><i data-lucide="users"
                            class="w-4 h-4 mr-2"></i>Directory</a>
                    <a href="#" onclick="app.handleLogout()"
                        class="flex items-center px-4 py-2 text-l text-white hover:bg-gray-600"><i data-lucide="log-out"
                            class="w-4 h-4 mr-2"></i>Logout</a>
                    <a href="#" onclick=" app.navigateTo('about')"
                        class="flex items-center px-4 py-2 text-l text-white hover:bg-gray-600"><i data-lucide="info"
                            class="w-4 h-4 mr-2"></i>About</a>
                    <div id="admin-dropdown-link" class="hidden">
                        <div class="border-t border-gray-600 my-1"></div>
                        <a href="#" onclick="event.preventDefault(); app.navigateTo('admin')"
                            class="flex items-center px-4 py-2 text-xl text-white hover:bg-gray-600"><i
                                data-lucide="shield" class="w-4 h-4 mr-2"></i>Admin Panel</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow p-4 md:p-6 overflow-y-auto no-scrollbar">
            <!-- All views will be rendered here -->
        </main>

        <!-- Navigation Bar -->
        <nav id="app-nav" class="bg-gray-900/50 backdrop-blur-sm p-2 sticky bottom-0 z-20 hidden">
            <div class="relative flex justify-around items-center h-16">
                <button onclick="app.navigateTo('dashboard')"
                    class="nav-button flex-1 flex flex-col items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700 transition-colors"><i
                        data-lucide="home"></i><span class="text-xs mt-1">Home</span></button>
                <button onclick="app.navigateTo('events')"
                    class="nav-button flex-1 flex flex-col items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700 transition-colors"><i
                        data-lucide="calendar-heart"></i><span class="text-xs mt-1">Events</span></button>

                <div class="absolute left-1/2 -translate-x-1/2 -top-6">
                    <button onclick="app.navigateTo('scanner')"
                        class="nav-button pride-gradient-bg w-20 h-20 flex items-center justify-center rounded-full shadow-lg text-white">
                        <i data-lucide="scan-line" class="w-8 h-8"></i>
                    </button>
                </div>
                <button onclick="app.navigateTo('scanner')"
                    class="nav-button flex-1 flex flex-col items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700 transition-colors"><i
                        data-lucide="scan-line"></i><span class="text-xs mt-1">Scan QR</span></button>


                <button onclick="app.navigateTo('rewards')"
                    class="nav-button flex-1 flex flex-col items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700 transition-colors"><i
                        data-lucide="gift"></i><span class="text-xs mt-1">Rewards</span></button>
                <button onclick="app.navigateTo('leaderboard')"
                    class="nav-button flex-1 flex flex-col items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700 transition-colors"><i
                        data-lucide="bar-chart-3"></i><span class="text-xs mt-1">Ranks</span></button>
            </div>
        </nav>

        <!-- Modals -->
        <div id="modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 hidden">
            <div id="modal-content"
                class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm text-center shadow-xl modal-fade-in">
                <div id="modal-icon" class="mx-auto mb-4"></div>
                <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
                <p id="modal-message" class="text-gray-300 mb-6"></p>
                <div id="modal-buttons" class="flex flex-col space-y-2"></div>
            </div>
        </div>
        <div id="fullscreen-modal" class="fixed inset-0 bg-gray-800 z-50 flex flex-col p-4 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 id="fullscreen-modal-title" class="text-xl font-bold"></h3><button
                    onclick="app.closeFullscreenModal()" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600"><i
                        data-lucide="x"></i></button>
            </div>
            <div id="fullscreen-modal-content" class="flex-grow overflow-y-auto no-scrollbar"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, getRedirectResult, sendPasswordResetEmail, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, arrayUnion, arrayRemove, increment, Timestamp, orderBy, limit, startAfter, documentId } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Main Application Logic ---
        const App = function () {
            // --- STATE MANAGEMENT ---
             const currentDate = new Date();
            this.state = {
                  calendarDate: currentDate,
                currentPage: 'auth',
                loggedInUser: null, // This will hold the user profile from Firestore
                firebaseUser: null, // This will hold the auth user object
                users: [], // All users for admin view
                events: [],
                rewards: [],
                announcements: [],
                badges: [],
                earnedBadges: [],
                rsvps: [],
                pointLogs: [], // Logs for the current user
                systemLogs: [], // For admin view
                logFilter: {
                    year: currentDate.getFullYear().toString(),
                    month: (currentDate.getMonth() + 1).toString(),
                    day: currentDate.getDate().toString(), // Set the default day to the current day
                },
                 adminEmail: 'titoycustodio@bipsu.edu.ph',
                adminActiveTab: 'verification',
                adminMemberSearch: '',
                adminRewardSearch: '',
                adminEditingRewardId: null, // To track the reward being edited
                allRewardsLoadedForAdmin: false, //  <-- ADD THIS LINE
                leaderboardDisplayCount: 10, // For client-side infinite scroll
                leaderboardLoading: false, // PREVENTS THE LOADING LOOP
                directorySearch: '',
                listeners: [], // To store unsubscribe functions for snapshots
                html5QrCode: null, // To hold the scanner instance
                calendarDate: new Date(),
            };

            // --- FIREBASE INSTANCES ---
            this.fb = {
                app: null,
                auth: null,
                db: null,
            };

            // --- Firestore collection paths ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'bbgs-pride-pass'; // Fallback for local dev
            this.paths = {
                users: `artifacts/${appId}/users`,
                userDoc: (uid) => `artifacts/${appId}/users/${uid}`,
                events: `artifacts/${appId}/public/data/events`,
                eventDoc: (eventId) => `artifacts/${appId}/public/data/events/${eventId}`,
                rewards: `artifacts/${appId}/public/data/rewards`,
                rewardDoc: (rewardId) => `artifacts/${appId}/public/data/rewards/${rewardId}`,
                announcements: `artifacts/${appId}/public/data/announcements`,
                badges: `artifacts/${appId}/public/data/badges`,
                badgeDoc: (badgeId) => `artifacts/${appId}/public/data/badges/${badgeId}`,
                rsvps: (userId) => `artifacts/${appId}/users/${userId}/rsvps`,
                checkIns: `artifacts/${appId}/public/data/checkIns`,
                pointLogs: (userId) => `artifacts/${appId}/users/${userId}/pointLogs`,
                claimedRewards: (userId) => `artifacts/${appId}/users/${userId}/claimedRewards`,
                earnedBadges: (userId) => `artifacts/${appId}/users/${userId}/earnedBadges`,
                systemLogs: `artifacts/${appId}/public/data/systemLogs`, // New path for audit logs
            };

            // --- DOM ELEMENTS ---
            this.elements = {
                mainContent: document.getElementById('main-content'), appHeader: document.getElementById('app-header'), appNav: document.getElementById('app-nav'), adminNavButton: document.getElementById('admin-nav-button'), userNameHeader: document.getElementById('user-name-header'), userPointsHeader: document.getElementById('user-points-header'), modal: document.getElementById('modal'), modalIcon: document.getElementById('modal-icon'), modalTitle: document.getElementById('modal-title'), modalMessage: document.getElementById('modal-message'), modalButtons: document.getElementById('modal-buttons'), fullscreenModal: document.getElementById('fullscreen-modal'), fullscreenModalTitle: document.getElementById('fullscreen-modal-title'), fullscreenModalContent: document.getElementById('fullscreen-modal-content'), loadingOverlay: document.getElementById('loading-overlay'), loadingText: document.getElementById('loading-text'), appContainer: document.getElementById('app'),
            };

            // --- TEMPLATES / VIEWS ---
            this.templates = {
                auth: () => `
                    <div class="text-center">
                        <img src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/236ecf96-a881-428d-9213-83d1c7313131/dkeifgy-9ff321c6-6ecc-45a8-8bab-23c6948a37fb.png?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7InBhdGgiOiJcL2ZcLzIzNmVjZjk2LWE4ODEtNDI4ZC05MjEzLTgzZDFjNzMxMzEzMVwvZGtlaWZneS05ZmYzMjFjNi02ZWNjLTQ1YTgtOGJhYi0yM2M2OTQ4YTM3ZmIucG5nIn1dXSwiYXVkIjpbInVybjpzZXJ2aWNlOmZpbGUuZG93bmxvYWQiXX0.VJGuojZj4NXBuMknJXQ2PmAAensLWE7pi2M7oFMWcfg" onerror="this.onerror=null;this.src='https://placehold.co/128x128/BE185D/FFFFFF?text=BBGS';" alt="BBGS Logo" class="w-24 h-24 rounded-2xl mx-auto mb-4 object-cover">
                        <h1 class="text-3xl font-bold mb-2">Welcome to <span class="pride-gradient-text">Pride Pass</span></h1>
                        <p class="text-gray-400 mb-8">Connecting Our Community, One Scan at a Time.</p>
                    </div>
                    <div x-data="{ tab: 'login' }" class="bg-gray-900 rounded-xl p-2">
                        <div class="flex space-x-2 mb-4"><button @click="tab = 'login'" :class="{ 'pride-gradient-bg text-white': tab === 'login', 'bg-gray-700 text-gray-300': tab !== 'login' }" class="flex-1 py-2 rounded-lg font-semibold transition-all">Log In</button><button @click="tab = 'register'" :class="{ 'pride-gradient-bg text-white': tab === 'register', 'bg-gray-700 text-gray-300': tab !== 'register' }" class="flex-1 py-2 rounded-lg font-semibold transition-all">Register</button></div>
                        <div x-show="tab === 'login'">
                            <form id="login-form" class="space-y-4 p-4">
                                <input name="email" type="email" placeholder="Email Address" required class="w-full bg-gray-700 border-2 border-transparent focus:border-pink-500 rounded-lg p-3 outline-none transition-all">
                                <input name="password" type="password" placeholder="Password" required class="w-full bg-gray-700 border-2 border-transparent focus:border-pink-500 rounded-lg p-3 outline-none transition-all">
                                <button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold transition-transform duration-200 active:scale-95">Log In</button>
                            </form>
                     <!--       <div class="relative my-4"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div><div class="relative flex justify-center text-sm"><span class="bg-gray-900 px-2 text-gray-400">Or continue with</span></div></div>
                            <button type="button" onclick="app.handleGoogleLogin()" class="w-full flex items-center justify-center space-x-2 bg-white text-gray-800 py-3 rounded-lg font-semibold transition-colors hover:bg-gray-200"><svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.021 35.596 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg><span>Sign in with Google</span></button>
                     -->   </div>
                        <div x-show="tab === 'register'" style="display: none;"><form id="register-form" class="space-y-4 p-4"><div class="grid grid-cols-2 gap-4"><input name="firstName" type="text" placeholder="First Name*" required class="w-full bg-gray-700 rounded-lg p-3"><input name="lastName" type="text" placeholder="Last Name*" required class="w-full bg-gray-700 rounded-lg p-3"><input name="middleName" type="text" placeholder="Middle Name" class="w-full bg-gray-700 rounded-lg p-3"><input name="suffix" type="text" placeholder="Suffix" class="w-full bg-gray-700 rounded-lg p-3"></div><input name="skills" type="text" placeholder="Skills/Talents (e.g., Host, Singer)" required class="w-full bg-gray-700 rounded-lg p-3"><input name="contact" type="tel" placeholder="Contact Number*" required class="w-full bg-gray-700 rounded-lg p-3"><input name="social" type="text" placeholder="Social Media Address" class="w-full bg-gray-700 rounded-lg p-3"><input name="email" type="email" placeholder="Email Address*" required class="w-full bg-gray-700 rounded-lg p-3"><input name="password" type="password" placeholder="Password*" required class="w-full bg-gray-700 rounded-lg p-3"><button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold">Create My Account</button></form></div>
                    </div>`,
                dashboard: () => {
                    const user = this.state.loggedInUser;
                    if (!user.isValidated) {
                        return `
                        <div class="text-center p-6 bg-gray-900/50 rounded-xl">
                            <i data-lucide="shield-alert" class="w-16 h-16 mx-auto text-amber-400 mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Account Pending Approval</h2>
                            <p class="text-gray-400">Your account has been registered successfully. An administrator will review your profile shortly. Once approved, you will have full access to all features.</p>
                        </div>
                        `;
                    }
                    const latestAnnouncement = this.state.announcements[0];
                    const earnedBadges = (user.earnedBadgeIds || []).map(badgeId => this.state.badges.find(b => b.id === badgeId)).filter(Boolean).slice(0, 5); // Show max 5 badges
                    return `
                    <div class="space-y-6">
                        ${latestAnnouncement ? `
                        <div class="bg-gray-900/50 p-4 rounded-xl border-l-4 border-pink-500">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="font-bold text-lg text-pink-400">Announcement</h3>
                                <p class="text-xs text-gray-400">${latestAnnouncement.timestamp}</p>
                            </div>
                            <p class="text-gray-300">${latestAnnouncement.message}</p>
                        </div>` : ''}

                        <div class="pride-gradient-bg p-1 rounded-2xl shadow-lg">
                            <div class="bg-gray-800 rounded-xl p-4 space-y-4">
                                <div class="flex space-x-4 items-center">
                                    <img src="${user.profilePic}" class="w-20 h-20 rounded-full object-cover border-4 border-gray-700">
                                    <div class="flex-1">
                                        <h2 class="text-xl font-bold">${user.firstName} ${user.lastName}</h2>
                                        <p class="text-sm text-gray-400">Member Since: ${user.memberSince || 'N/A'}</p>
                                    </div>
                                    <div class="bg-white p-1 rounded-lg cursor-pointer" onclick="app.openMemberQrModal()">
                                        <canvas id="member-qr-code"></canvas>
                                    </div>
                                </div>
                                ${earnedBadges.length > 0 ? `
                                <div class="border-t border-gray-700 pt-3">
                                    <div class="flex items-center justify-center space-x-3">
                                        ${earnedBadges.map(badge => this.renderBadgeIcon(badge.icon, 'w-6 h-6 text-amber-400')).join('')}
                                    </div>
                                </div>` : ''}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="app.navigateTo('scanner')" class="bg-gray-700 p-4 rounded-xl flex flex-col items-center justify-center space-y-2 hover:bg-gray-600 transition-colors">
                                <i data-lucide="scan-line" class="text-pink-400"></i>
                                <span class="font-semibold">Scan QR Code</span>
                            </button>
                            <button onclick="app.navigateTo('profile')" class="bg-gray-700 p-4 rounded-xl flex flex-col items-center justify-center space-y-2 hover:bg-gray-600 transition-colors">
                                <i data-lucide="user-circle" class="text-purple-400"></i>
                                <span class="font-semibold">My Profile</span>
                            </button>
                        </div>
                    </div>`;
                },
                events: () => {
                    return `
                    <div x-data="{ view: 'calendar' }">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Events</h2>
                            <div class="bg-gray-900/50 p-1 rounded-lg flex space-x-1">
                                <button @click="view = 'calendar'" :class="{ 'bg-gray-700': view === 'calendar' }" class="p-2 rounded-md"><i data-lucide="calendar"></i></button>
                                <button @click="view = 'list'" :class="{ 'bg-gray-700': view === 'list' }" class="p-2 rounded-md"><i data-lucide="list"></i></button>
                            </div>
                        </div>

                        <div x-show="view === 'calendar'">
                            ${this.generateCalendar()}
                        </div>

                        <div x-show="view === 'list'" style="display: none;">
                            <div class="space-y-4">
                            ${this.state.events.filter(e => e.isVisible).map(event => {
                        const hasRSVPd = this.state.rsvps.some(rsvp => rsvp.eventId === event.id);
                        const badge = event.badgeId ? this.state.badges.find(b => b.id === event.badgeId) : null;
                        return `
                                <div class="bg-gray-700 p-4 rounded-lg">
                                    <h3 class="text-lg font-bold">${event.name}</h3>
                                    <p class="text-sm text-amber-400 mb-2">+${event.points} Points for attending</p>
                                    <p class="text-gray-300 text-sm mb-4">${event.description || 'No description available.'}</p>
                                    ${badge ? `
                                    <div class="border-t border-gray-600 my-3 pt-3 flex items-center space-x-2">
                                        ${this.renderBadgeIcon(badge.icon, 'w-5 h-5 text-amber-400')}
                                        <p class="text-xs text-gray-300">Unlocks the "${badge.name}" badge!</p>
                                    </div>
                                    ` : ''}
                                    <button onclick="app.handleRsvp('${event.id}')" class="${hasRSVPd ? 'bg-green-500/20 text-green-400' : 'pride-gradient-bg text-white'} w-full py-2 rounded-lg font-semibold text-sm">
                                        ${hasRSVPd ? 'âœ“ RSVP\'d' : 'RSVP Now'}
                                    </button>
                                </div>
                                `}).join('') || '<p class="text-gray-400 text-center">No upcoming events. Check back soon!</p>'}
                            </div>
                        </div>
                    </div>
                    `
                },
                rewards: () => {
                    return `
                    <h2 class="text-2xl font-bold text-center mb-6">Available Rewards</h2>
                    <div class="space-y-4">
                    ${this.state.rewards.filter(r => r.isVisible).map(reward => {
                        const badge = reward.badgeId ? this.state.badges.find(b => b.id === reward.badgeId) : null;
                        const limitText = reward.claimLimitType === 'limited' ? `${reward.claimsLeft} / ${reward.claimLimit} left` : '';
                        return `
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-bold">${reward.name}</h3>
                                    <p class="text-sm ${reward.type === 'cost' ? 'text-red-400' : 'text-green-400'}">${reward.type === 'cost' ? '-' : '+'}${reward.cost} Points</p>
                                    ${limitText ? `<p class="text-xs text-gray-400 mt-1">${limitText}</p>` : ''}
                                </div>
                                <button onclick="app.showModal('info', 'How to Claim', 'Scan this reward\\'s QR code at an official BBGS event or with an admin to claim.')" class="bg-gray-600 p-2 rounded-lg"><i data-lucide="help-circle"></i></button>
                            </div>
                            ${badge ? `
                            <div class="border-t border-gray-600 mt-3 pt-3 flex items-center space-x-2">
                                ${this.renderBadgeIcon(badge.icon, 'w-5 h-5 text-amber-400')}
                                <p class="text-xs text-gray-300">Also unlocks the "${badge.name}" badge!</p>
                            </div>
                            ` : ''}
                        </div>
                        `
                    }).join('')}
                    </div>

                    <div class="text-center py-6">
                        ${this.state.rewardsLoading ?
                            `<div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-pink-500"></div>` :
                            (!this.state.rewardsAllLoaded ?
                                `<button onclick="app.fetchRewards()" class="pride-gradient-bg text-white font-semibold px-6 py-2 rounded-lg transition-transform active:scale-95">Load More</button>` :
                                (this.state.rewards.length > 0 ? '<p class="text-gray-500">You have reached the end.</p>' : '<p class="text-gray-400 text-center">No rewards available right now.</p>')
                            )
                        }
                    </div>
                    `
                },
                badges: () => {
                    const earnedBadges = this.state.badges.filter(b => this.state.earnedBadges.some(eb => eb.badgeId === b.id));
                    const unearnedBadges = this.state.badges.filter(b => b.isVisible && !this.state.earnedBadges.some(eb => eb.badgeId === b.id));

                    return `
                    <h2 class="text-2xl font-bold text-center mb-6">Achievements</h2>
                    
                    <div>
                        <h3 class="text-lg font-semibold pride-gradient-text mb-3">Earned Badges</h3>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                            ${earnedBadges.length > 0 ? earnedBadges.map(badge => `
                                <div class="badge-item text-center p-2 bg-gray-700 rounded-lg cursor-pointer" 
                                     data-name="${badge.name.replace(/"/g, '&quot;')}" 
                                     data-description="${badge.description.replace(/"/g, '&quot;')}"
                                     data-icon="${badge.icon}"
                                     data-earned="true">
                                    ${this.renderBadgeIcon(badge.icon, 'w-12 h-12 mx-auto text-amber-400')}
                                    <p class="text-xs mt-2 font-semibold">${badge.name}</p>
                                </div>
                            `).join('') : '<p class="text-gray-400 text-center col-span-full">No badges earned yet.</p>'}
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold pride-gradient-text mb-3">Achievements to Unlock</h3>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                            ${unearnedBadges.length > 0 ? unearnedBadges.map(badge => `
                                <div class="badge-item text-center p-2 bg-gray-700 rounded-lg cursor-pointer opacity-40" 
                                     data-name="${badge.name.replace(/"/g, '&quot;')}" 
                                     data-description="${badge.description.replace(/"/g, '&quot;')}"
                                     data-icon="${badge.icon}"
                                     data-earned="false">
                                    ${this.renderBadgeIcon(badge.icon, 'w-12 h-12 mx-auto text-gray-500')}
                                    <p class="text-xs mt-2 font-semibold">${badge.name}</p>
                                </div>
                            `).join('') : '<p class="text-gray-400 text-center col-span-full">No more badges to unlock for now!</p>'}
                        </div>
                    </div>
                    `
                },
                directory: () => {
                    const filteredUsers = this.state.users.filter(u => u.isPublic && u.isValidated && u.email !== this.state.adminEmail &&
                        ((u.firstName + ' ' + u.lastName).toLowerCase().includes(this.state.directorySearch) || (u.skills || '').toLowerCase().includes(this.state.directorySearch))
                    );
                    return `
                    <h2 class="text-2xl font-bold text-center mb-4">Member Directory</h2>
                    <div class="flex space-x-2 mb-4">
                        <input id="directory-search-input" type="search" placeholder="Search by name or skill..." class="w-full bg-gray-700 rounded-lg p-3">
                        <button onclick="app.handleDirectorySearch()" class="pride-gradient-bg px-4 rounded-lg"><i data-lucide="search"></i></button>
                    </div>
                    <div class="space-y-2">
                    ${filteredUsers.map(user => {
                        const earnedBadges = (user.earnedBadgeIds || []).map(badgeId => this.state.badges.find(b => b.id === badgeId)).filter(Boolean).slice(0, 3);
                        return `
                        <div class="bg-gray-700 p-3 rounded-lg flex items-center space-x-4 cursor-pointer hover:bg-gray-600" onclick="app.openMemberDetailsModal('${user.id}')">
                            <img src="${user.profilePic}" class="w-12 h-12 rounded-full object-cover">
                            <div class="flex-1">
                                <p class="font-bold">${user.firstName} ${user.lastName}</p>
                                <p class="text-sm text-gray-400">${user.skills || 'No skills listed'}</p>
                            </div>
                            <div class="flex space-x-1">
                                ${earnedBadges.map(badge => this.renderBadgeIcon(badge.icon, 'w-5 h-5 text-amber-400')).join('')}
                            </div>
                        </div>
                    `}).join('') || '<p class="text-gray-400 text-center">No members match your search.</p>'}
                    </div>
                    `
                },

                leaderboard: () => {
                    const rankedUsers = this.state.users
                        .filter(u => u.isValidated)
                        .sort((a, b) => b.points - a.points);

                    const usersToShow = rankedUsers.slice(0, this.state.leaderboardDisplayCount);
                    const currentUser = this.state.loggedInUser;

                    return `
                    <h2 class="text-2xl font-bold text-center mb-6">Points Leaderboard</h2>
                    <div class="space-y-2">
                    ${usersToShow.map((user, index) => {
                        const earnedBadges = (user.earnedBadgeIds || []).map(badgeId => this.state.badges.find(b => b.id === badgeId)).filter(Boolean).slice(0, 3);
                        const isCurrentUser = user.id === currentUser.id;

                        let rankIndicator = `<span class="text-lg font-bold w-8 text-center">${index + 1}</span>`;
                        if (index === 0) {
                            rankIndicator = `<img src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExMHFudzU4aGkxNGRpbG54MG9nbzdqNTZnamN3cXhvZjRvd2V6bmZtZyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/ZMVwfXq4d1p3GOx50w/giphy.gif" class="w-15 h-12">`;
                        } else if (index === 1) {
                            rankIndicator = `<i data-lucide="trophy" class="w-6 h-6 text-gray-400"></i>`;
                        } else if (index === 2) {
                            rankIndicator = `<i data-lucide="trophy" class="w-6 h-6 text-yellow-600"></i>`;
                        }

                        return `
                        <div class="fade-in-item bg-gray-700 p-3 rounded-lg flex items-center space-x-4 ${isCurrentUser ? 'border-2 border-pink-500' : ''}" style="animation-delay: ${index * 50}ms;">
                            <div class="w-8 flex justify-center">${rankIndicator}</div>
                            <img src="${user.profilePic}" class="w-12 h-12 rounded-full object-cover">
                            <div class="flex-1">
                                <p class="font-bold">${user.firstName} ${user.lastName}</p>
                                <div class="flex space-x-1 mt-1">
                                    ${earnedBadges.map(badge => this.renderBadgeIcon(badge.icon, 'w-4 h-4 text-amber-400')).join('')}
                                </div>
                            </div>
                            <p class="font-bold text-amber-400">${user.points} PTS</p>
                        </div>
                        `
                    }).join('')}
                    </div>
                    <div class="text-center py-6 h-12">
                        ${this.state.leaderboardLoading ?
                            `<div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-pink-500"></div>` :
                            (this.state.leaderboardDisplayCount < rankedUsers.length ?
                                `<button onclick="app.loadMoreLeaderboard()" class="pride-gradient-bg text-white font-semibold px-6 py-2 rounded-lg transition-transform active:scale-95">Show More</button>` :
                                (rankedUsers.length > 0 ? '<p class="text-gray-500">You have reached the end.</p>' : '')
                            )
                        }
                    </div>
                    `
                },
                scanner: () => `<div class="text-center"><h2 class="text-2xl font-bold mb-2">Scan QR Code</h2><p class="text-gray-400 mb-4">Scan an event or reward QR code.</p><div id="qr-reader" class="w-full rounded-2xl overflow-hidden border-4 border-gray-700"></div><p id="qr-reader-status" class="mt-4 text-sm text-gray-400">Initializing camera...</p></div>`,
                about: () => `<h2 class="text-2xl font-bold text-center mb-6">About Pride Pass</h2><div class="space-y-6 bg-gray-900/50 p-6 rounded-xl"><div><h3 class="font-semibold text-lg text-pink-400 mb-2">BBGS Pride Pass: Your Community Hub</h3><p class="text-gray-300">The BBGS Pride Pass is a digital initiative by the Biliran Bisexual and Gay Society. Itâ€™s your all-in-one community pass, using an innovative QR code system to connect us, streamline event check-ins, and make it easier than ever to be an active part of the BBGS family.</p></div><div><h3 class="font-semibold text-lg text-purple-400 mb-2">Points, Badges, & Leaderboard</h3><p class="text-gray-300">We celebrate your engagement!<br> Our <storng>Points & Badges System</strong> rewards you for attending events, volunteering, and participating in workshops. As you earn points, you'll unlock special digital badges and climb the <strong>Leaderboard</strong>, showcasing your commitment to the community. Redeem your points for exclusive merch, VIP access, and more!</p></div><div><h3 class="font-semibold text-lg text-amber-400 mb-2">Support & Connect</h3><p class="text-gray-300">This platform was built to serve you. Your support is vital for our growth and for adding more features for the community. For technical issues, feedback, or inquiries about the platform, please contact our administrator:<br><strong class="text-white"><!--${this.state.adminEmail}--> Tito Amerigo V. Custodio, Jr., MIT <br> titoycustodio@bipsu.edu.ph</strong><br><strong>09666517133</strong></p></div><p class="text-center text-xs text-gray-500 pt-4">App Version 2.0.2 (BBGS Pride Pass QR Code System) <br> Â© 2025 BBGS Dev Tootz </p></div>`,
                profile: () => {
                    const user = this.state.loggedInUser;
                    const earnedBadges = this.state.earnedBadges.map(earned => this.state.badges.find(b => b.id === earned.badgeId)).filter(Boolean);
                    return `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">My Profile</h2>
                        <button onclick="app.openPointsLogModal()" class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded-lg text-sm font-semibold hover:bg-gray-600"><i data-lucide="history"></i><span>View Log</span></button>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg mb-4 text-center">
                        <p class="font-semibold">Verification Status:</p>
                        ${user.isValidated ? `<p class="text-green-400 font-bold">âœ“ Verified on ${user.validatedAt || ''}</p>` : '<p class="text-amber-400 font-bold">Pending Approval</p>'}
                    </div>
                    <form id="profile-form">
                        <div class="flex flex-col items-center space-y-4 mb-6">
                            <img id="profile-pic-preview" src="${user.profilePic}" class="w-32 h-32 rounded-full object-cover border-4 border-purple-500">
                            <label class="bg-gray-700 px-4 py-2 rounded-lg font-semibold text-sm cursor-pointer hover:bg-gray-600">Change Photo<input type="file" id="profile-pic-upload" class="hidden" accept="image/*"></label>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-sm text-gray-400">First Name</label><input name="firstName" value="${user.firstName}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div>
                                <div><label class="text-sm text-gray-400">Last Name</label><input name="lastName" value="${user.lastName}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div>
                            </div>
                            <div><label class="text-sm text-gray-400">Skills/Talents</label><input name="skills" value="${user.skills}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div>
                            <div><label class="text-sm text-gray-400">Email</label><input name="email" value="${user.email}" class="w-full bg-gray-600 rounded-lg p-3 mt-1" readonly></div>
                            <div class="bg-gray-900/50 p-4 rounded-lg flex justify-between items-center">
                                <label for="directory-opt-in" class="font-semibold">Show in Member Directory</label>
                                <input type="checkbox" id="directory-opt-in" onchange="app.handleDirectoryOptIn(this.checked)" ${user.isPublic ? 'checked' : ''} class="h-6 w-6 rounded-md accent-pink-500">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">App Theme</label>
                                <select id="theme-selector" onchange="app.handleThemeChange(this.value)" class="w-full bg-gray-700 rounded-lg p-3 mt-1">
                                    <option value="default" ${user.theme === 'default' ? 'selected' : ''}>Default</option>
                                    <option value="light" ${user.theme === 'light' ? 'selected' : ''}>Golden White</option>
                                    <option value="blue" ${user.theme === 'blue' ? 'selected' : ''}>Blue Spectrum</option>
                                    <option value="green" ${user.theme === 'green' ? 'selected' : ''}>Green</option>
                                    <option value="pink" ${user.theme === 'pink' ? 'selected' : ''}>Pink Glitter</option>
                                    <option value="rainbow2" ${user.theme === 'rainbow2' ? 'selected' : ''}>Linear Rainbow</option>
                                    <option value="rainbow" ${user.theme === 'rainbow' ? 'selected' : ''}>Digital Rainbow </option>
                                </select>
                            </div>
                        </div>
                    </form>
                    
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-center mb-4">My Achievements</h3>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                            ${earnedBadges.length > 0 ? earnedBadges.map(badge => `
                                <div class="badge-item text-center p-2 bg-gray-700 rounded-lg cursor-pointer" data-name="${badge.name.replace(/"/g, '&quot;')}" data-description="${badge.description.replace(/"/g, '&quot;')}" data-icon="${badge.icon}" data-earned="true">
                                    ${this.renderBadgeIcon(badge.icon, 'w-12 h-12 mx-auto text-amber-400')}
                                    <p class="text-xs mt-2 font-semibold">${badge.name}</p>
                                </div>
                            `).join('') : '<p class="text-gray-400 text-center col-span-full">No badges earned yet. Attend events to get started!</p>'}
                        </div>
                    </div>

                    <button type="submit" form="profile-form" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold mt-8">Save Changes</button>
                    <button type="button" onclick="app.handleLogout()" class="w-full bg-red-500/20 text-red-400 py-3 rounded-lg font-semibold mt-4">Log Out</button>
                `;
                },
                admin: () => {
                    const unverifiedUsers = this.state.users.filter(u => !u.isValidated);
                    const filteredRewards = this.state.rewards.filter(r => r.name && typeof r.name === 'string' && r.name.toLowerCase().includes(this.state.adminRewardSearch));
                    const filteredMembers = this.state.users.filter(u => u.isValidated && u.email !== this.state.adminEmail && (u.firstName + ' ' + u.lastName).toLowerCase().includes(this.state.adminMemberSearch));
                    const editingReward = this.state.adminEditingRewardId ? this.state.rewards.find(r => r.id === this.state.adminEditingRewardId) : null;

                    // Logic for filtering logs
                    const filteredLogs = this.state.systemLogs.filter(log => {
                        if (!log.timestamp || !log.timestamp.toDate) return false;
                        const logDate = log.timestamp.toDate();
                        const { year, month, day } = this.state.logFilter;
                        if (year !== 'all' && logDate.getFullYear() != year) return false;
                        if (month !== 'all' && (logDate.getMonth() + 1) != month) return false;
                        if (day !== 'all' && logDate.getDate() != day) return false;
                        return true;
                    });

                    return `<h2 class="text-2xl font-bold text-center mb-6">Admin Panel</h2><div x-data="{ tab: '${this.state.adminActiveTab}' }" @tab-change.window="tab = $event.detail" class="bg-gray-900 rounded-xl p-2"><div class="flex flex-wrap justify-center gap-2 mb-4"><button @click="tab = 'verification'" :class="{ 'pride-gradient-bg text-white': tab === 'verification', 'bg-gray-700 text-gray-300': tab !== 'verification' }" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm">Verification <span class="bg-pink-500 text-white text-xs font-bold rounded-full px-2 ml-1">${unverifiedUsers.length}</span></button><button @click="tab = 'members'" :class="{ 'pride-gradient-bg text-white': tab === 'members', 'bg-gray-700 text-gray-300': tab !== 'members' }" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm">Members</button><button @click="tab = 'events'" :class="{ 'pride-gradient-bg text-white': tab === 'events', 'bg-gray-700 text-gray-300': tab !== 'events' }" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm">Events</button><button @click="tab = 'rewards'" :class="{ 'pride-gradient-bg text-white': tab === 'rewards', 'bg-gray-700 text-gray-300': tab !== 'rewards' }" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm">Rewards</button><button @click="tab = 'badges'" :class="{ 'pride-gradient-bg text-white': tab === 'badges', 'bg-gray-700 text-gray-300': tab !== 'badges' }" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm">Badges</button><button @click="tab = 'announcements'" :class="{ 'pride-gradient-bg text-white': tab === 'announcements', 'bg-gray-700 text-gray-300': tab !== 'announcements' }" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm">Announce</button><button @click="tab = 'scan'" :class="{ 'pride-gradient-bg text-white': tab === 'scan', 'bg-gray-700 text-gray-300': tab !== 'scan' }" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm">Scan QR</button><button @click="tab = 'logs'" :class="{ 'pride-gradient-bg text-white': tab === 'logs', 'bg-gray-700 text-gray-300': tab !== 'logs' }" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm">Logs</button></div><div x-show="tab === 'verification'"><h3 class="font-semibold text-lg mb-2 text-center">Pending Approvals</h3><div class="space-y-2">${unverifiedUsers.map(user => `<div class="bg-gray-700 p-3 rounded-lg"><div class="flex items-center justify-between"> <div class="flex items-center space-x-3"><img src="${user.profilePic}" class="w-10 h-10 rounded-full object-cover"><div> <p class="font-semibold">${user.firstName} ${user.lastName}</p><p class="text-xs text-gray-400">${user.email}</p></div></div><div class="flex space-x-2"><button onclick="app.handleAdminApproveUser('${user.id}')" class="p-2 bg-green-500/20 text-green-400 rounded-md"><i data-lucide="check"></i></button><button onclick="app.handleAdminDeleteUser('${user.id}')" class="p-2 bg-red-500/20 text-red-400 rounded-md"><i data-lucide="x"></i></button></div></div></div>`).join('') || '<p class="text-gray-400 text-center py-4">No new users to verify.</p>'}</div></div><div x-show="tab === 'events'"><div class="bg-gray-800 p-4 rounded-lg mb-4"><h3 class="font-semibold text-lg mb-4">Create New Event</h3><form id="create-event-form" class="space-y-4"><input name="eventName" type="text" placeholder="Event Name" required class="w-full bg-gray-700 rounded-lg p-3"><input name="eventDate" type="datetime-local" required class="w-full bg-gray-700 rounded-lg p-3 text-white"><textarea name="eventDescription" placeholder="Event Description (optional)" class="w-full bg-gray-700 rounded-lg p-3 h-24"></textarea><input name="eventPoints" type="number" placeholder="Points Value" required class="w-full bg-gray-700 rounded-lg p-3"><select name="badgeId" class="w-full bg-gray-700 rounded-lg p-3"><option value="">No Badge for this Event</option>${this.state.badges.map(badge => `<option value="${badge.id}">${badge.name}</option>`).join('')}</select><div class="flex items-center space-x-2"><input type="checkbox" id="event-visible" name="isVisible" checked class="h-5 w-5 rounded accent-pink-500"><label for="event-visible">Visible to Members</label></div><button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold">Create Event</button></form></div><h3 class="font-semibold text-lg mb-4">Managed Events</h3><div id="events-list" class="space-y-2">${this.state.events.map(event => `<div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between"><div><p class="font-semibold">${event.name}</p><p class="text-sm text-amber-400">${event.points} Points</p></div><button onclick="app.openEventDetailsModal('${event.id}')" class="text-xs text-pink-400 hover:underline">View Details</button></div>`).join('') || '<p class="text-gray-400 text-center">No events created.</p>'}</div></div>
                    <div x-show="tab === 'rewards'" style="display: none;">
                        <div id="reward-form-panel" class="bg-gray-800 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold text-lg mb-4">${editingReward ? 'Edit Reward' : 'Add New Reward'}</h3>
                            <form id="reward-form" class="space-y-4" x-data="{ claimType: '${editingReward?.claimType || 'once'}', limitType: '${editingReward?.claimLimitType || 'unlimited'}' }">
                                <input name="rewardName" type="text" placeholder="Reward Name" required class="w-full bg-gray-700 rounded-lg p-3" value="${editingReward?.name || ''}">
                                <input name="rewardCost" type="number" placeholder="Point Value" required class="w-full bg-gray-700 rounded-lg p-3" value="${editingReward?.cost || ''}">
                                <select name="rewardType" class="w-full bg-gray-700 rounded-lg p-3">
                                    <option value="cost" ${editingReward?.type === 'cost' ? 'selected' : ''}>Cost (Subtracts Points)</option>
                                    <option value="gain" ${editingReward?.type === 'gain' ? 'selected' : ''}>Gain (Adds Points)</option>
                                </select>
                                <select name="badgeId" class="w-full bg-gray-700 rounded-lg p-3">
                                    <option value="">No Badge for this Reward</option>
                                    ${this.state.badges.map(badge => `<option value="${badge.id}" ${editingReward?.badgeId === badge.id ? 'selected' : ''}>${badge.name}</option>`).join('')}
                                </select>
                                <div><label class="text-sm text-gray-400">Claim Frequency</label><select name="claimType" x-model="claimType" class="w-full bg-gray-700 rounded-lg p-3 mt-1"><option value="once">Once Only</option><option value="daily">Once a Day (Scheduled)</option><option value="scheduled">Specific Dates</option></select></div>
                                <div x-show="claimType === 'daily'" class="bg-gray-900/50 p-3 rounded-lg space-y-2"><label class="text-sm text-gray-400">Active Days</label><div class="grid grid-cols-4 gap-2 text-xs">${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `<div><input type="checkbox" name="day_${day.toLowerCase()}" id="day_${i}" value="${i}" ${(editingReward?.dailySchedule?.days?.includes(i)) ? 'checked' : ''}> <label for="day_${i}">${day}</label></div>`).join('')}</div><label class="text-sm text-gray-400">Active Time Ranges</label><div id="daily-times-container" class="space-y-2"></div><button type="button" onclick="app.addDailyTimeRow()" class="text-sm text-pink-400 hover:underline">+ Add Time Range</button></div>
                                <div x-show="claimType === 'scheduled'" class="space-y-2"><div id="scheduled-dates-container"></div><button type="button" onclick="app.addScheduleRow()" class="text-sm text-pink-400 hover:underline">+ Add Date/Time</button></div>
                                <div><label class="text-sm text-gray-400">Total Availability</label><select name="claimLimitType" x-model="limitType" class="w-full bg-gray-700 rounded-lg p-3 mt-1"><option value="unlimited">Unlimited</option><option value="limited">Limited</option></select></div>
                                <div x-show="limitType === 'limited'"><input name="claimLimit" type="number" placeholder="Total number of claims" class="w-full bg-gray-700 rounded-lg p-3 mt-1" value="${editingReward?.claimLimit || ''}"></div>
                                <div class="flex items-center space-x-2"><input type="checkbox" id="reward-visible" name="isVisible" ${editingReward ? (editingReward.isVisible ? 'checked' : '') : 'checked'} class="h-5 w-5 rounded accent-pink-500"><label for="reward-visible">Visible to Members</label></div>
                                <div class="flex space-x-2">
                                    <button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold">${editingReward ? 'Save Changes' : 'Add Reward'}</button>
                                    ${editingReward ? `<button type="button" onclick="app.cancelEditRewardMode()" class="w-full bg-gray-600 text-white py-3 rounded-lg font-semibold">Cancel</button>` : ''}
                                </div>
                            </form>
                        </div>
                       <h3 class="font-semibold text-lg mb-2">Available Rewards</h3>
<div class="flex space-x-2 mb-4">
    <input type="search" id="admin-reward-search-input" placeholder="Search rewards..." class="w-full bg-gray-700 rounded-lg p-3">
    <button onclick="app.handleAdminRewardSearch()" class="pride-gradient-bg px-4 rounded-lg"><i data-lucide="search"></i></button>
    <button onclick="app.showAllRewards()" class="bg-gray-600 px-4 rounded-lg">Show All</button>
</div>
                        <div id="rewards-list" class="space-y-2">${filteredRewards.map(reward => `<div class="bg-gray-700 p-3 rounded-lg"><div class="flex items-center justify-between"><div><p class="font-semibold">${reward.name}</p><p class="text-sm ${reward.type === 'cost' ? 'text-red-400' : 'text-green-400'}">${reward.type === 'cost' ? '-' : '+'}${reward.cost} Points</p></div><div class="flex items-center space-x-2"><div class="bg-white p-1 rounded-md cursor-pointer" onclick="app.openRewardQrModal('${reward.id}')"><canvas id="reward-qr-${reward.id}" class="reward-qr-canvas" data-reward-id="${reward.id}"></canvas></div><button onclick="app.switchToEditRewardMode('${reward.id}'); document.querySelector('[data-tab=rewards]').click();" class="p-2 bg-gray-600 rounded-md hover:bg-gray-500"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="app.handleAdminDeleteReward('${reward.id}')" class="p-2 bg-red-900/50 rounded-md hover:bg-red-900/80"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div>`).join('') || '<p class="text-gray-400 text-center">No rewards found.</p>'}</div>
                    </div>
                    <div x-show="tab === 'members'" style="display: none;"><div class="bg-gray-800 p-4 rounded-lg mb-4 flex justify-between items-center">
                        <h3 class="font-semibold text-lg">Add New Member</h3>
                        <button onclick="app.openAddMemberModal()" class="pride-gradient-bg text-white font-semibold px-4 py-2 rounded-lg text-sm">Add Account</button></div><h3 class="font-semibold text-lg mb-2">Registered Members</h3><input type="search" oninput="app.handleAdminSearch('member', this.value)" placeholder="Search members by name..." class="w-full bg-gray-700 rounded-lg p-3 mb-4"><div id="members-list" class="space-y-2">${filteredMembers.map(user => `<div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between"><div class="flex items-center space-x-3"><img src="${user.profilePic}" class="w-10 h-10 rounded-full object-cover"><div><p class="font-semibold">${user.firstName} ${user.lastName}</p><p class="text-xs text-gray-400">${user.email}</p></div></div><div class="text-right"><p class="font-bold text-amber-400">${user.points} PTS</p><button onclick="app.openUserEditModal('${user.id}')" class="text-xs text-pink-400 hover:underline">Edit</button></div></div>`).join('') || '<p class="text-gray-400 text-center">No members found.</p>'}</div></div><div x-show="tab === 'badges'" style="display: none;"><div class="bg-gray-800 p-4 rounded-lg mb-4"><h3 class="font-semibold text-lg mb-4">Create New Badge</h3><form id="create-badge-form" class="space-y-4"><input name="badgeName" type="text" placeholder="Badge Name" required class="w-full bg-gray-700 rounded-lg p-3"><input name="badgeDescription" type="text" placeholder="Description" required class="w-full bg-gray-700 rounded-lg p-3"><div x-data="{ method: 'select' }"><label class="text-sm text-gray-400">Icon</label><div class="flex space-x-2 p-1 bg-gray-800 rounded-lg my-1"><button type="button" @click="method = 'select'" :class="{ 'pride-gradient-bg text-white': method === 'select', 'bg-gray-700': method !== 'select' }" class="flex-1 py-1 rounded-md text-sm">Select from List</button><button type="button" @click="method = 'text'" :class="{ 'pride-gradient-bg text-white': method === 'text', 'bg-gray-700': method !== 'text' }" class="flex-1 py-1 rounded-md text-sm">Type Name</button><button type="button" @click="method = 'url'" :class="{ 'pride-gradient-bg text-white': method === 'url', 'bg-gray-700': method !== 'url' }" class="flex-1 py-1 rounded-md text-sm">Use URL</button></div><div x-show="method === 'select'"><div class="flex items-center space-x-2"><select name="badgeIconSelect" class="w-full bg-gray-700 rounded-lg p-3">${this.getIconOptions()}</select></div></div><div x-show="method === 'text'" style="display: none;"><input name="badgeIconText" type="text" placeholder="e.g., 'rocket', 'award'" class="w-full bg-gray-700 rounded-lg p-3"></div><div x-show="method === 'url'" style="display: none;"><input name="badgeIconUrl" type="url" placeholder="https://example.com/icon.png" class="w-full bg-gray-700 rounded-lg p-3"></div></div><div x-data="{ criteria: 'special' }"><label class="text-sm text-gray-400">Criteria</label><select name="badgeCriteriaType" @change="criteria = $event.target.value" class="w-full bg-gray-700 rounded-lg p-3 mt-1"><option value="special">Special (Admin Awarded)</option><option value="points">Points Earned</option><option value="events">Events Attended</option></select><div x-show="criteria !== 'special'"><input name="badgeCriteriaValue" type="number" placeholder="Value (e.g., 500)" class="w-full bg-gray-700 rounded-lg p-3 mt-2"></div></div><div class="flex items-center space-x-2"><input type="checkbox" id="badge-visible" name="isVisible" checked class="h-5 w-5 rounded accent-pink-500"><label for="badge-visible">Visible to Members</label></div><button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold">Create Badge</button></form></div><h3 class="font-semibold text-lg mb-2">Manage Badges</h3><div class="space-y-2">${this.state.badges.map(badge => `<div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between"> <div class="flex items-center space-x-3"> ${this.renderBadgeIcon(badge.icon, 'w-8 h-8 text-amber-400')} <div> <p class="font-semibold">${badge.name}</p> <p class="text-xs text-gray-400">${badge.description}</p> </div> </div> <div class="flex items-center space-x-2"><button onclick="app.openBadgeEditModal('${badge.id}')" class="p-2 bg-gray-600 rounded-md hover:bg-gray-500"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="app.handleDeleteBadge('${badge.id}')" class="p-2 bg-red-900/50 rounded-md hover:bg-red-900/80"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div> </div>`).join('') || '<p class="text-gray-400 text-center">No badges created.</p>'}</div></div><div x-show="tab === 'announcements'" style="display: none;"><div class="bg-gray-800 p-4 rounded-lg mb-4"><h3 class="font-semibold text-lg mb-4">Post New Announcement</h3><form id="create-announcement-form" class="space-y-4"><textarea name="announcementMessage" placeholder="Your message here..." required class="w-full bg-gray-700 rounded-lg p-3 h-28"></textarea><button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold">Post Announcement</button></form></div><h3 class="font-semibold text-lg mb-2">Recent Announcements</h3><div class="space-y-2">${this.state.announcements.map(item => `<div class="bg-gray-700 p-3 rounded-lg"> <p>${item.message}</p> <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-600"> <p class="text-xs text-gray-400">${item.timestamp}</p> <button onclick="app.handleDeleteAnnouncement('${item.id}')" class="p-1 text-red-400 hover:bg-red-900/50 rounded-md"><i data-lucide="trash-2" class="w-4 h-4"></i></button> </div> </div>`).join('') || '<p class="text-gray-400 text-center">No announcements yet.</p>'}</div></div><div x-show="tab === 'scan'" style="display: none;"><h3 class="font-semibold text-lg mb-2">Award via QR Scan</h3><div class="space-y-4 bg-gray-700 p-4 rounded-lg"><p class="text-sm text-gray-300">Select a reward or badge to give to the member upon scanning their QR code.</p><div><label for="admin-reward-select" class="block text-sm font-medium text-gray-300 mb-1">Select Reward</label><select id="admin-reward-select" class="w-full bg-gray-800 rounded-lg p-3 outline-none"><option value="">-- No Reward --</option>${this.state.rewards.map(r => `<option value="${r.id}" data-points="${r.cost}">${r.name} (${r.type === 'gain' ? '+' : '-'}${r.cost} pts)</option>`).join('')}</select></div><div><label for="admin-badge-select" class="block text-sm font-medium text-gray-300 mb-1">Select Badge</label><select id="admin-badge-select" class="w-full bg-gray-800 rounded-lg p-3 outline-none"><option value="">-- No Badge --</option>${this.state.badges.map(b => `<option value="${b.id}">${b.name}</option>`).join('')}</select></div><div id="admin-qr-reader" class="w-full rounded-lg overflow-hidden"></div><p id="admin-scan-status" class="text-center text-yellow-400 h-4"></p><button id="start-scan-btn" onclick="app.startAdminScanner()" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold flex items-center justify-center space-x-2"><i data-lucide="camera"></i><span>Start Scan</span></button></div></div><div x-show="tab === 'logs'" style="display: none;"><h3 class="font-semibold text-lg mb-4 text-center">System Activity Logs</h3><div class="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-4"><select id="log-year-select" class="bg-gray-700 rounded-lg p-2 text-sm"><option value="all" ${this.state.logFilter.year === 'all' ? 'selected' : ''}>All Years</option>${[...new Set(this.state.systemLogs.map(l => l.timestamp.toDate().getFullYear()))].sort((a, b) => b - a).map(year => `<option value="${year}" ${this.state.logFilter.year == year ? 'selected' : ''}>${year}</option>`).join('')}</select><select id="log-month-select" class="bg-gray-700 rounded-lg p-2 text-sm"><option value="all" ${this.state.logFilter.month === 'all' ? 'selected' : ''}>All Months</option>${Array.from({ length: 12 }, (_, i) => `<option value="${i + 1}" ${this.state.logFilter.month == (i + 1) ? 'selected' : ''}>${new Date(0, i).toLocaleString('default', { month: 'long' })}</option>`).join('')}</select><select id="log-day-select" class="bg-gray-700 rounded-lg p-2 text-sm"><option value="all" ${this.state.logFilter.day === 'all' ? 'selected' : ''}>All Days</option>${Array.from({ length: 31 }, (_, i) => `<option value="${i + 1}" ${this.state.logFilter.day == (i + 1) ? 'selected' : ''}>${i + 1}</option>`).join('')}</select><button onclick="app.applyLogFilter()" class="pride-gradient-bg text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center justify-center space-x-2"><i data-lucide="search" class="w-4 h-4"></i><span>Search</span></button></div><div class="space-y-2">${filteredLogs.map(log => `<div class="bg-gray-700 p-3 rounded-lg text-sm"><p><strong class="text-amber-400">${log.actorName || 'System'}</strong> ${log.details}</p>${log.beforePoints !== undefined ? `<p class="text-xs text-gray-400">Points: ${log.beforePoints} â†’ ${log.afterPoints}</p>` : ''}<p class="text-xs text-gray-400 mt-1">${log.timestamp.toDate().toLocaleString()}</p></div>`).join('') || '<p class="text-gray-400 text-center py-4">No logs match the current filter.</p>'}</div></div></div>`;
                }
            };

            // --- FIREBASE INITIALIZATION ---
            this.init = async () => {
                // Your web app's Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyAL8QL2VnPKOgVGtNKVmVAAcbcUZa9AOgg",
                    authDomain: "qrcode-7f9c0.firebaseapp.com",
                    projectId: "qrcode-7f9c0",
                    storageBucket: "qrcode-7f9c0.appspot.com",
                    messagingSenderId: "511564194366",
                    appId: "1:511564194366:web:f4a5bda9e35b404103676f",
                    measurementId: "G-QRL1B9JHND"
                };

                try {
                    this.fb.app = initializeApp(firebaseConfig);
                    this.fb.auth = getAuth(this.fb.app);
                    this.fb.db = getFirestore(this.fb.app);
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.elements.loadingText.textContent = "Connection failed. Please refresh.";
                    this.elements.loadingText.classList.add('text-red-400');
                    return;
                }

                await this.handleRedirectResult();

                onAuthStateChanged(this.fb.auth, async (user) => {
                    this.detachListeners(); // Clear old listeners on auth state change
                    if (user && !user.isAnonymous) {
                        this.state.firebaseUser = user;
                        const userDoc = await getDoc(doc(this.fb.db, this.paths.userDoc(user.uid)));
                        if (userDoc.exists()) {
                            this.state.loggedInUser = { id: user.uid, ...userDoc.data() };
                            this.elements.appHeader.classList.remove('hidden');
                            this.elements.appNav.classList.remove('hidden');
                            this.applyTheme(this.state.loggedInUser.theme);
                            this.attachListeners(); // Attach all necessary listeners for the logged-in user
                            this.updateUserInfo();
                            this.navigateTo('dashboard');
                        } else {
                            // User exists in Auth, but not in Firestore database. Log them out.
                            this.handleLogout();
                        }
                    } else {
                        this.state.firebaseUser = null;
                        this.state.loggedInUser = null;
                        this.elements.appHeader.classList.add('hidden');
                        this.elements.appNav.classList.add('hidden');
                        this.applyTheme('default');
                        this.navigateTo('auth');
                    }
                    this.elements.loadingOverlay.classList.add('hidden');
                });
            };

            // --- REAL-TIME LISTENERS ---
            this.attachListeners = () => {
                // Listeners for data specific to the logged-in user
                const userListener = onSnapshot(doc(this.fb.db, this.paths.userDoc(this.state.firebaseUser.uid)), (doc) => {
                    this.state.loggedInUser = { id: doc.id, ...doc.data() };
                    this.updateUserInfo();
                    this.applyTheme(this.state.loggedInUser.theme);
                    if (this.state.currentPage === 'profile') this.render();
                });
                this.state.listeners.push(userListener);

                const logsListener = onSnapshot(query(collection(this.fb.db, this.paths.pointLogs(this.state.firebaseUser.uid))), (snapshot) => {
                    this.state.pointLogs = snapshot.docs.map(doc => doc.data());
                });
                this.state.listeners.push(logsListener);

                const rsvpListener = onSnapshot(query(collection(this.fb.db, this.paths.rsvps(this.state.firebaseUser.uid))), (snapshot) => {
                    this.state.rsvps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (this.state.currentPage === 'events') this.render();
                });
                this.state.listeners.push(rsvpListener);

                const earnedBadgesListener = onSnapshot(query(collection(this.fb.db, this.paths.earnedBadges(this.state.firebaseUser.uid))), (snapshot) => {
                    this.state.earnedBadges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (this.state.currentPage === 'profile') this.render();
                });
                this.state.listeners.push(earnedBadgesListener);

                // Listeners for public/shared data
                const eventsListener = onSnapshot(query(collection(this.fb.db, this.paths.events)), (snapshot) => {
                    this.state.events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (['admin', 'events'].includes(this.state.currentPage)) this.render();
                });
                this.state.listeners.push(eventsListener);



                const allUsersListener = onSnapshot(query(collection(this.fb.db, this.paths.users)), (snapshot) => {
                    this.state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (['admin', 'directory', 'leaderboard'].includes(this.state.currentPage)) this.render();
                });
                this.state.listeners.push(allUsersListener);

                const announcementsListener = onSnapshot(query(collection(this.fb.db, this.paths.announcements)), (snapshot) => {
                    this.state.announcements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    if (['admin', 'dashboard'].includes(this.state.currentPage)) this.render();
                });
                this.state.listeners.push(announcementsListener);

                const badgesListener = onSnapshot(query(collection(this.fb.db, this.paths.badges)), (snapshot) => {
                    this.state.badges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (['admin', 'profile', 'badges', 'scan'].includes(this.state.currentPage)) this.render();
                });
                this.state.listeners.push(badgesListener);

                // New listener for system logs (only for admin)
                if (this.state.loggedInUser.email === this.state.adminEmail) {
                    const systemLogsListener = onSnapshot(query(collection(this.fb.db, this.paths.systemLogs), orderBy('timestamp', 'desc')), (snapshot) => {
                        this.state.systemLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (this.state.currentPage === 'admin') this.render();
                    });
                    this.state.listeners.push(systemLogsListener);
                }
            };

            this.detachListeners = () => {
                this.state.listeners.forEach(unsubscribe => unsubscribe());
                this.state.listeners = [];
            };

            // --- ROUTING & RENDERING ---
            this.render = () => { const template = this.templates[this.state.currentPage]; if (template) { this.elements.mainContent.innerHTML = template(); this.postRender(); } };
            this.navigateTo = (page) => {
                // Remove any existing scroll listener from the previous page
                this.elements.mainContent.onscroll = null;

                if (this.state.currentPage === 'scanner' && this.qrScanner) this.stopScanner();
                if (this.state.loggedInUser && !this.state.loggedInUser.isValidated && ['scanner', 'directory', 'leaderboard', 'rewards', 'badges'].includes(page)) {
                    return this.showModal('info', 'Account Pending', 'This feature is available after your account is approved by an admin.');
                }
                

                if (page === 'admin') {
                    this.fetchAllRewardsForAdmin();
                }

                this.state.currentPage = page;
                if (page === 'rewards') {
                    this.state.rewards = [];
                    this.state.rewardsLastDoc = null;
                    this.state.rewardsAllLoaded = false;
                    this.fetchRewards(); // Fetch the first batch
                }



                // If navigating to the leaderboard, reset its display count
                if (page === 'leaderboard') {
                    this.state.leaderboardDisplayCount = 10;
                    this.state.leaderboardLoading = false; // Reset the loading flag
                }

                this.updateNav();
                this.render();
            };
            this.updateNav = () => { document.querySelectorAll('.nav-button').forEach(btn => { btn.classList.remove('pride-gradient-text'); btn.classList.add('text-gray-400'); }); const activeBtn = document.querySelector(`.nav-button[onclick="app.navigateTo('${this.state.currentPage}')"]`); if (activeBtn) { activeBtn.classList.add('pride-gradient-text'); activeBtn.classList.remove('text-gray-400'); } };
            this.postRender = () => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                if (window.Alpine) {
                    window.Alpine.discoverUninitializedComponents((el) => window.Alpine.initializeComponent(el));
                }
                switch (this.state.currentPage) {
                    case 'dashboard':
                        if (this.state.loggedInUser.isValidated) this.generateQRCode('member-qr-code', JSON.stringify({ type: 'member', id: this.state.loggedInUser.id }), 80);
                        break;
                    case 'leaderboard':
                        const mainEl = this.elements.mainContent;
                        mainEl.onscroll = () => {
                            const rankedUsers = this.state.users.filter(u => u.isValidated);
                            // If we are already loading or all items are shown, do nothing.
                            if (this.state.leaderboardLoading || this.state.leaderboardDisplayCount >= rankedUsers.length) {
                                return;
                            }

                            // Check if user is near the bottom (150px threshold)
                            if (mainEl.scrollTop + mainEl.clientHeight >= mainEl.scrollHeight - 150) {
                                this.state.leaderboardLoading = true; // Set loading flag to true
                                this.render(); // Re-render to show the spinner

                                // Use a short delay to load the next batch
                                setTimeout(() => {
                                    this.state.leaderboardDisplayCount += 10; // Increase the number of users to show
                                    this.state.leaderboardLoading = false; // Reset the flag
                                    this.render(); // Re-render with the new items
                                }, 500);
                            }
                        };
                        break;
                    case 'profile':
                        document.getElementById('profile-form').addEventListener('submit', this.handleProfileUpdate.bind(this));
                        document.getElementById('profile-pic-upload').addEventListener('change', this.handleProfilePicChange.bind(this));
                        break;
                    case 'scanner':
                        this.startScanner();
                        break;
                    case 'admin':
                        if (document.getElementById('reward-form')) {
                            document.getElementById('reward-form').addEventListener('submit', (e) => {
                                e.preventDefault();
                                if (this.state.adminEditingRewardId) {
                                    this.handleAdminUpdateReward(e);
                                } else {
                                    this.handleCreateReward(e);
                                }
                            });
                        }
                        if (this.state.adminEditingRewardId) {
                            const reward = this.state.rewards.find(r => r.id === this.state.adminEditingRewardId);
                            if (reward?.claimType === 'daily' && reward.dailySchedule?.times) {
                                reward.dailySchedule.times.forEach(time => this.addDailyTimeRow(time.start, time.end));
                            }
                            if (reward?.claimType === 'scheduled' && reward.schedules) {
                                reward.schedules.forEach(schedule => {
                                    const [date, start] = schedule.startDate.split('T');
                                    const [, end] = schedule.endDate.split('T');
                                    this.addScheduleRow(date, start, end);
                                });
                            }
                        }
                        if (document.getElementById('create-event-form')) document.getElementById('create-event-form').addEventListener('submit', this.handleCreateEvent.bind(this));
                        if (document.getElementById('create-announcement-form')) document.getElementById('create-announcement-form').addEventListener('submit', this.handleCreateAnnouncement.bind(this));
                        if (document.getElementById('create-badge-form')) document.getElementById('create-badge-form').addEventListener('submit', this.handleCreateBadge.bind(this));
                        document.querySelectorAll('.reward-qr-canvas').forEach(canvas => {
                            const rewardId = canvas.dataset.rewardId;
                            if (rewardId) {
                                this.generateQRCode(canvas.id, JSON.stringify({ type: 'reward', id: rewardId }), 48);
                            }
                        });
                        break;
                }
            };

            // --- LOGGING ---
            this.logAction = async (action, details, pointsChange = null) => {
                const user = this.state.loggedInUser;
                if (!user) return; // Don't log if no user
                const logEntry = {
                    timestamp: Timestamp.now(),
                    actorId: user.id,
                    actorName: `${user.firstName} ${user.lastName}`,
                    action: action,
                    details: details,
                };
                if (pointsChange) {
                    logEntry.beforePoints = pointsChange.before;
                    logEntry.afterPoints = pointsChange.after;
                }
                try {
                    await addDoc(collection(this.fb.db, this.paths.systemLogs), logEntry);
                } catch (error) {
                    console.error("Failed to write to system log:", error);
                }
            };

            this.applyLogFilter = () => {
                const year = document.getElementById('log-year-select').value;
                const month = document.getElementById('log-month-select').value;
                const day = document.getElementById('log-day-select').value;
                this.state.logFilter = { year, month, day };
                this.render();
            };

            // --- CALENDAR ---
            this.generateCalendar = () => {
                const now = this.state.calendarDate;
                const month = now.getMonth();
                const year = now.getFullYear();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const monthName = now.toLocaleString('default', { month: 'long' });

                let calendarHtml = `
                <div class="bg-gray-900/50 p-4 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="app.changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-700"><i data-lucide="chevron-left"></i></button>
                        <h3 class="text-lg font-semibold">${monthName} ${year}</h3>
                        <button onclick="app.changeMonth(1)" class="p-2 rounded-full hover:bg-gray-700"><i data-lucide="chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-2">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div class="grid grid-cols-7 gap-1">
                `;

                for (let i = 0; i < firstDay; i++) { calendarHtml += `<div></div>`; }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEvents = this.state.events.filter(e => {
                        if (!e.timestamp || typeof e.timestamp.seconds !== 'number') return false; // Bug Fix
                        const eventDate = new Date(e.timestamp.seconds * 1000);
                        return eventDate.getDate() === day && eventDate.getMonth() === month && eventDate.getFullYear() === year;
                    });
                    const hasEvents = dayEvents.length > 0;
                    calendarHtml += `<div class="relative p-2 rounded-lg ${hasEvents ? 'bg-pink-500/20 cursor-pointer' : ''}" ${hasEvents ? `onclick="app.showEventsForDay(${day})"` : ''}>
                        ${day}
                        ${hasEvents ? '<div class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-pink-400 rounded-full"></div>' : ''}
                    </div>`;
                }

                calendarHtml += `</div></div>`;
                return calendarHtml;
            };
            this.changeMonth = (delta) => {
                this.state.calendarDate.setMonth(this.state.calendarDate.getMonth() + delta);
                this.render();
            };
            this.showEventsForDay = (day) => {
                const month = this.state.calendarDate.getMonth();
                const year = this.state.calendarDate.getFullYear();
                const dayEvents = this.state.events.filter(e => {
                    if (!e.timestamp || typeof e.timestamp.seconds !== 'number') return false;
                    const eventDate = new Date(e.timestamp.seconds * 1000);
                    return eventDate.getDate() === day && eventDate.getMonth() === month && eventDate.getFullYear() === year;
                });
                const content = `<div class="space-y-4">${dayEvents.map(event => `
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-bold">${event.name}</h3>
                        <p class="text-sm text-amber-400 mb-2">+${event.points} Points for attending</p>
                        <p class="text-gray-300 text-sm">${event.description || 'No description available.'}</p>
                    </div>
                `).join('')}</div>`;
                this.openFullscreenModal(`Events for ${this.state.calendarDate.toLocaleString('default', { month: 'long' })} ${day}`, content);
            };

            // --- QR CODE ---
            this.generateQRCode = (canvasId, text, size) => { const canvas = document.getElementById(canvasId); if (canvas) QRCode.toCanvas(canvas, text, { width: size, margin: 1 }, (err) => { if (err) console.error(err); }); };
            this.qrScanner = null;
            this.startScanner = () => { const statusEl = document.getElementById('qr-reader-status'); this.qrScanner = new Html5Qrcode("qr-reader"); this.qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => { this.handleScanSuccess(decodedText); this.stopScanner(); }, () => { }).catch(() => { statusEl.textContent = "Could not start camera."; }); statusEl.textContent = "Point camera at a QR code."; };
            this.stopScanner = () => { if (this.qrScanner && this.qrScanner.isScanning) { this.qrScanner.stop().catch(err => console.error("Scanner stop failed", err)); } };

            // (Line 1836)
            this.handleScanSuccess = async (decodedText) => {
                try {
                    const qrData = JSON.parse(decodedText);
                    const user = this.state.loggedInUser;
                    const batch = writeBatch(this.fb.db);
                    const beforePoints = user.points; // Get points before the change

                    if (qrData.type === 'event' && qrData.id) {
                        const eventRef = doc(this.fb.db, this.paths.eventDoc(qrData.id));
                        const eventSnap = await getDoc(eventRef);

                        if (!eventSnap.exists()) {
                            return this.showModal('error', 'Event Not Found', 'This event QR code is invalid or the event has been removed.');
                        }
                        const officialEventData = eventSnap.data();
                        const checkInRef = doc(this.fb.db, this.paths.checkIns, `${user.id}_${qrData.id}`);
                        const checkInSnap = await getDoc(checkInRef);
                        if (checkInSnap.exists()) {
                            return this.showModal('info', 'Already Checked In', `You've already checked in for this event.`);
                        }

                        const afterPoints = beforePoints + officialEventData.points;
                        batch.set(checkInRef, { userId: user.id, eventId: qrData.id, timestamp: new Date().toLocaleString() });
                        const userRef = doc(this.fb.db, this.paths.userDoc(user.id));
                        batch.update(userRef, { points: increment(officialEventData.points) });
                        // --- CHANGE IS HERE ---
                        await this.addPointLog(user.id, `Attended: ${officialEventData.name || 'Event'}`, officialEventData.points, batch, beforePoints, afterPoints);
                        await this.logAction('EVENT_CHECK_IN', `Checked into event: "${officialEventData.name}"`, { before: beforePoints, after: afterPoints });


                        if (officialEventData.badgeId) {
                            await this.awardBadge(user.id, officialEventData.badgeId, batch);
                        }

                        await batch.commit();
                        this.showModal('success', 'Check-In Successful!', `You earned ${officialEventData.points} points.`);
                        this.checkAndAwardBadges(user.id);
                    }
                    else if (qrData.type === 'reward' && qrData.id) {
                        const rewardRef = doc(this.fb.db, this.paths.rewardDoc(qrData.id));
                        const rewardSnap = await getDoc(rewardRef);

                        if (!rewardSnap.exists()) {
                            return this.showModal('error', 'Reward Not Found', 'This reward QR code is invalid or the reward is no longer available.');
                        }
                        const officialRewardData = rewardSnap.data();

                        // Check claim limits
                        if (officialRewardData.claimLimitType === 'limited' && officialRewardData.claimsLeft <= 0) {
                            return this.showModal('info', 'Reward Unavailable', 'This reward has been fully claimed.');
                        }

                        // Check claim frequency
                        const todayStr = new Date().toLocaleDateString();
                        const now = new Date();
                        const currentDay = now.getDay(); // 0 = Sunday
                        const currentTime = now.toTimeString().slice(0, 5); // "HH:MM"

                        if (officialRewardData.claimType === 'daily') {
                            const schedule = officialRewardData.dailySchedule || { days: [], times: [] };
                            if (!schedule.days.includes(currentDay)) {
                                return this.showModal('info', 'Not Available Today', 'This reward is not available today.');
                            }
                            const inTimeRange = schedule.times.some(time => currentTime >= time.start && currentTime <= time.end);
                            if (!inTimeRange) {
                                return this.showModal('info', 'Not Active Now', 'This reward is not active at this time. Check the schedule.');
                            }
                            const lastClaimDoc = await getDoc(doc(this.fb.db, this.paths.claimedRewards(user.id), `${qrData.id}_${todayStr}`));
                            if (lastClaimDoc.exists()) {
                                return this.showModal('info', 'Claimed Today', 'You have already claimed this daily reward today. Try again tomorrow!');
                            }
                        }

                        if (officialRewardData.claimType === 'once') {
                            const onceClaimDoc = await getDoc(doc(this.fb.db, this.paths.claimedRewards(user.id), qrData.id));
                            if (onceClaimDoc.exists()) {
                                return this.showModal('info', 'Already Claimed', 'You have already claimed this reward.');
                            }
                        }


                        // Check scheduled dates
                        if (officialRewardData.claimType === 'scheduled') {
                            const activeSchedule = (officialRewardData.schedules || []).find(s => {
                                const start = new Date(s.startDate);
                                const end = new Date(s.endDate);
                                return now >= start && now <= end;
                            });

                            if (!activeSchedule) {
                                return this.showModal('info', 'Not Active', 'This reward is not active at this time.');
                            }

                            // Create a unique ID for this specific claim window
                            const claimIdForSchedule = `${qrData.id}_${activeSchedule.startDate}`;
                            const scheduledClaimDoc = await getDoc(doc(this.fb.db, this.paths.claimedRewards(user.id), claimIdForSchedule));

                            if (scheduledClaimDoc.exists()) {
                                return this.showModal('info', 'Already Claimed', 'You have already claimed this reward for this specific schedule.');
                            }
                        }

                        const userRef = doc(this.fb.db, this.paths.userDoc(user.id));
                        let newPoints = user.points;
                        let logMessage = '';

                        if (officialRewardData.type === 'cost') {
                            if (user.points < officialRewardData.cost) {
                                return this.showModal('error', 'Insufficient Points', `You need ${officialRewardData.cost} points, but you only have ${user.points}.`);
                            }
                            newPoints -= officialRewardData.cost;
                            logMessage = `Redeemed: ${officialRewardData.name || 'Reward'}`;
                        } else {
                            newPoints += officialRewardData.cost;
                            logMessage = `Gained: ${officialRewardData.name || 'Reward'}`;
                        }

                        // Set claim record
                        if (officialRewardData.claimType === 'daily') {
                            batch.set(doc(this.fb.db, this.paths.claimedRewards(user.id), `${qrData.id}_${todayStr}`), { rewardId: qrData.id, timestamp: new Date().toLocaleString() });
                        }
                        else if (officialRewardData.claimType === 'scheduled') {
                            const activeSchedule = (officialRewardData.schedules || []).find(s => {
                                const start = new Date(s.startDate);
                                const end = new Date(s.endDate);
                                return new Date() >= start && new Date() <= end;
                            });
                            if (activeSchedule) {
                                const claimIdForSchedule = `${qrData.id}_${activeSchedule.startDate}`;
                                batch.set(doc(this.fb.db, this.paths.claimedRewards(user.id), claimIdForSchedule), { rewardId: qrData.id, timestamp: new Date().toLocaleString() });
                            }
                        } else {
                            batch.set(doc(this.fb.db, this.paths.claimedRewards(user.id), qrData.id), { rewardId: qrData.id, timestamp: new Date().toLocaleString() });
                        }

                        batch.update(userRef, { points: newPoints });
                        if (officialRewardData.claimLimitType === 'limited') {
                            batch.update(rewardRef, { claimsLeft: increment(-1) });
                        }

                        // --- CHANGE IS HERE ---
                        await this.addPointLog(user.id, logMessage, officialRewardData.type === 'cost' ? -officialRewardData.cost : officialRewardData.cost, batch, beforePoints, newPoints);
                        await this.logAction('REWARD_CLAIM', `Claimed reward: "${officialRewardData.name}"`, { before: beforePoints, after: newPoints });

                        if (officialRewardData.badgeId) {
                            await this.awardBadge(user.id, officialRewardData.badgeId, batch);
                        }

                        await batch.commit();
                        this.showModal('success', 'Reward Claimed!', `You ${officialRewardData.type === 'cost' ? 'redeemed' : 'gained'} ${officialRewardData.name || 'a reward'}.`);
                        this.checkAndAwardBadges(user.id);
                    } else {
                        this.showModal('error', 'Invalid QR Code', 'This is not a valid BBGS QR code.');
                    }
                    this.navigateTo('dashboard');
                } catch (e) {
                    console.error("Scan processing error:", e);
                    this.showModal('error', 'Scan Failed', 'Could not process the QR code. It might be corrupted or invalid.');
                }
            };



            this.loadMoreLeaderboard = () => {
                if (this.state.leaderboardLoading) return; // Prevent multiple clicks

                this.state.leaderboardLoading = true;
                this.render(); // Show the loading spinner

                // Use a short delay to let the UI update before loading more
                setTimeout(() => {
                    this.state.leaderboardDisplayCount += 10; // Increase the number of users to show
                    this.state.leaderboardLoading = false; // Reset the flag
                    this.render(); // Re-render with the new items
                }, 500);
            };
            
            // (This goes after the loadMoreLeaderboard function around line 1999)

            this.fetchAllRewardsForAdmin = async () => {
                // Only run if rewards haven't been loaded for the admin yet
                if (this.state.allRewardsLoadedForAdmin) return;

                try {
                    const rewardsRef = collection(this.fb.db, this.paths.rewards);
                    const querySnapshot = await getDocs(rewardsRef);

                    // Replace the current rewards list with the full list for the admin
                    this.state.rewards = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    this.state.allRewardsLoadedForAdmin = true; // Mark as loaded
                    this.render(); // Re-render the admin panel with the data
                } catch (error) {
                    console.error("Error fetching all rewards for admin:", error);
                    this.showModal('error', 'Load Failed', 'Could not load rewards for the admin panel.');
                }
            };

            this.fetchRewards = async () => {
                if (this.state.rewardsLoading || this.state.rewardsAllLoaded) return;
                this.state.rewardsLoading = true;
                this.render(); // Re-render to show a loading spinner

                try {
                    const rewardsRef = collection(this.fb.db, this.paths.rewards);
                    const PAGE_SIZE = 10;
                    let q;

                    if (this.state.rewardsLastDoc) {
                        // If we have a 'last document', start the next query after it
                        q = query(rewardsRef, orderBy(documentId()), startAfter(this.state.rewardsLastDoc), limit(PAGE_SIZE));
                    } else {
                        // This is the first fetch
                        q = query(rewardsRef, orderBy(documentId()), limit(PAGE_SIZE));
                    }

                    const querySnapshot = await getDocs(q);
                    const newRewards = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (querySnapshot.docs.length > 0) {
                        // Save the last document from this batch for the next fetch
                        this.state.rewardsLastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    }

                    // If we fetched fewer rewards than the page size, we've reached the end
                    if (newRewards.length < PAGE_SIZE) {
                        this.state.rewardsAllLoaded = true;
                    }

                    // Add the new rewards to the existing list
                    this.state.rewards = [...this.state.rewards, ...newRewards];

                } catch (error) {
                    console.error("Error fetching rewards:", error);
                    this.showModal('error', 'Load Failed', 'Could not load rewards.');
                } finally {
                    this.state.rewardsLoading = false;
                    this.render(); // Re-render with the new data
                }
            };


            // --- USER & POINTS LOGIC ---
            // (Line 2011)
            this.addPointLog = async (userId, description, points, batch, beforePoints, afterPoints) => {
                const logRef = doc(collection(this.fb.db, this.paths.pointLogs(userId)));
                const logData = {
                    description,
                    points,
                    timestamp: new Date().toLocaleString(),
                    beforePoints: beforePoints, // Add this line
                    afterPoints: afterPoints   // Add this line
                };
                if (batch) {
                    batch.set(logRef, logData);
                } else {
                    await setDoc(logRef, logData);
                }
            };
            this.handleLogin = async (e) => { e.preventDefault(); const email = e.target.elements.email.value; const password = e.target.elements.password.value; try { const userCredential = await signInWithEmailAndPassword(this.fb.auth, email, password); const user = this.state.users.find(u => u.id === userCredential.user.uid); if (user) { this.state.loggedInUser = user; await this.logAction('USER_LOGIN', `User logged in.`); } } catch (error) { this.showModal('error', 'Login Failed', error.message); } };
            this.handleRegister = async (e) => { e.preventDefault(); const formData = new FormData(e.target); const newUser = Object.fromEntries(formData.entries()); try { const userCredential = await createUserWithEmailAndPassword(this.fb.auth, newUser.email, newUser.password); const user = userCredential.user; const userProfile = { email: newUser.email, firstName: newUser.firstName, lastName: newUser.lastName, middleName: newUser.middleName || '', suffix: newUser.suffix || '', skills: newUser.skills, contact: newUser.contact, social: newUser.social || '', points: 0, profilePic: `https://placehold.co/400x400/F59E0B/FFFFFF?text=${newUser.firstName.charAt(0)}`, memberSince: new Date().toLocaleDateString(), isPublic: false, isValidated: false, validatedAt: null, earnedBadgeIds: [], theme: 'default' }; await setDoc(doc(this.fb.db, this.paths.userDoc(user.uid)), userProfile); this.state.loggedInUser = { id: user.uid, ...userProfile }; await this.logAction('USER_REGISTER', `New user registered: ${newUser.email}`); await this.addPointLog(user.uid, 'Account Created', 0); } catch (error) { this.showModal('error', 'Registration Failed', error.message); } };
            this.handleLogout = async () => { await this.logAction('USER_LOGOUT', `User logged out.`); await signOut(this.fb.auth); };
            this.handleGoogleLogin = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(this.fb.auth, provider);
                    const user = result.user;
                    const userDocRef = doc(this.fb.db, this.paths.userDoc(user.uid));
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        const [firstName, ...lastNameParts] = user.displayName.split(' ');
                        const userProfile = { email: user.email, firstName: firstName || 'New', lastName: lastNameParts.join(' ') || 'User', skills: 'N/A', contact: '', social: '', points: 100, profilePic: user.photoURL || `https://placehold.co/400x400/F59E0B/FFFFFF?text=${(firstName || 'N').charAt(0)}`, memberSince: new Date().toLocaleDateString(), isPublic: false, isValidated: false, validatedAt: null, earnedBadgeIds: [], theme: 'default' };
                        await setDoc(userDocRef, userProfile);
                        this.state.loggedInUser = { id: user.uid, ...userProfile };
                        await this.logAction('USER_REGISTER', `New user registered with Google: ${user.email}`);
                        await this.addPointLog(user.uid, 'Account Created with Google', 100);
                    } else {
                        this.state.loggedInUser = { id: user.uid, ...userDoc.data() };
                        await this.logAction('USER_LOGIN', `User logged in with Google.`);
                    }
                } catch (error) {
                    this.showModal('error', 'Google Sign-In Failed', error.message);
                }
            };
            this.handleRedirectResult = async () => {
                try {
                    const result = await getRedirectResult(this.fb.auth);
                    if (result) {
                        // Logic is now in handleGoogleLogin
                    }
                } catch (error) {
                    console.error("Google Redirect Error:", error);
                    this.showModal('error', 'Google Sign-In Failed', error.message);
                }
            };
            this.handleProfilePicChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const newPicDataUrl = event.target.result;
                    const previewPic = document.getElementById('profile-pic-preview');
                    if (previewPic) previewPic.src = newPicDataUrl;
                    const headerPic = document.getElementById('header-profile-pic');
                    if (headerPic) headerPic.src = newPicDataUrl;
                    try {
                        await updateDoc(doc(this.fb.db, this.paths.userDoc(this.state.firebaseUser.uid)), {
                            profilePic: newPicDataUrl
                        });
                        this.showModal('success', 'Photo Updated', 'Your new profile picture has been saved.');
                    } catch (error) {
                        this.showModal('error', 'Update Failed', 'Could not save the new photo.');
                    }
                };
                reader.readAsDataURL(file);
            };
            this.handleProfileUpdate = async (e) => { e.preventDefault(); const formData = new FormData(e.target); const updatedData = { firstName: formData.get('firstName'), lastName: formData.get('lastName'), skills: formData.get('skills') }; try { await updateDoc(doc(this.fb.db, this.paths.userDoc(this.state.firebaseUser.uid)), updatedData); await this.logAction('PROFILE_UPDATE', 'Updated their profile information.'); this.showModal('success', 'Profile Updated', 'Your information has been saved.'); } catch (error) { this.showModal('error', 'Update Failed', error.message); } };
            this.updateUserInfo = () => {
                if (this.state.loggedInUser) {
                    this.elements.userNameHeader.textContent = this.state.loggedInUser.firstName;
                    this.elements.userPointsHeader.textContent = `${this.state.loggedInUser.points} PTS`;
                    const headerPic = document.getElementById('header-profile-pic');
                    if (headerPic) {
                        headerPic.src = this.state.loggedInUser.profilePic;
                    }
                    document.getElementById('admin-dropdown-link').style.display = this.state.loggedInUser.email === this.state.adminEmail ? 'block' : 'none';
                }
            };
            this.handleDirectoryOptIn = async (isPublic) => { await updateDoc(doc(this.fb.db, this.paths.userDoc(this.state.firebaseUser.uid)), { isPublic }); };
            this.handleRsvp = async (eventId) => { const userId = this.state.firebaseUser.uid; const rsvpRef = doc(this.fb.db, this.paths.rsvps(userId), eventId); const rsvpSnap = await getDoc(rsvpRef); if (rsvpSnap.exists()) { await deleteDoc(rsvpRef); } else { await setDoc(rsvpRef, { eventId, userId, timestamp: new Date().toLocaleString() }); } };

            // --- ADMIN FUNCTIONALITY ---
            this.switchToEditRewardMode = (rewardId) => {
                this.state.adminEditingRewardId = rewardId;
                this.render();
                // Scroll to the form for better UX
                document.getElementById('reward-form-panel')?.scrollIntoView({ behavior: 'smooth' });
            };
            this.cancelEditRewardMode = () => {
                this.state.adminEditingRewardId = null;
                this.render();
            };
            this.startAdminScanner = async () => {
                const startBtn = document.getElementById('start-scan-btn');
                const statusEl = document.getElementById('admin-scan-status');

                if (this.state.html5QrCode && this.state.html5QrCode.isScanning) {
                    this.state.html5QrCode.stop().then(() => {
                        this.state.html5QrCode = null;
                        startBtn.innerHTML = '<i data-lucide="camera"></i><span>Start Scan</span>';
                        lucide.createIcons();
                        statusEl.textContent = '';
                    }).catch(err => console.error("Error stopping scanner:", err));
                    return;
                }

                this.state.html5QrCode = new Html5Qrcode("admin-qr-reader");
                const qrCodeSuccessCallback = async (decodedText) => {
                    if (this.state.html5QrCode.isScanning) {
                        this.state.html5QrCode.stop();
                    }
                    statusEl.textContent = `Processing...`;

                    let scannedData;
                    try {
                        scannedData = JSON.parse(decodedText);
                    } catch (e) {
                        this.showModal('error', 'Invalid QR', 'This is not a valid member QR code.');
                        statusEl.textContent = 'Error!';
                        return;
                    }


                    if (scannedData.type !== 'member' || !scannedData.id) {
                        this.showModal('error', 'Wrong QR Type', 'Please scan a member\'s personal QR code.');
                        statusEl.textContent = 'Error!';
                        return;
                    }

                    const userId = scannedData.id;
                    const rewardSelect = document.getElementById('admin-reward-select');
                    const badgeSelect = document.getElementById('admin-badge-select');
                    const selectedRewardId = rewardSelect.value;
                    const selectedBadgeId = badgeSelect.value;

                    if (!selectedRewardId && !selectedBadgeId) {
                        this.showModal('error', 'No Selection', 'Please select a reward or a badge to award.');
                        statusEl.textContent = `Scan failed: No selection.`;
                        return;
                    }

                    try {
                        const userRef = doc(this.fb.db, this.paths.userDoc(userId));
                        const userSnap = await getDoc(userRef);

                        if (!userSnap.exists()) throw new Error("User not found.");

                        const userData = userSnap.data();
                        const beforePoints = userData.points;
                        let afterPoints = beforePoints;
                        let pointsAwarded = 0;
                        let badgeAwarded = null;
                        const batch = writeBatch(this.fb.db);

                        if (selectedRewardId) {
                            const reward = this.state.rewards.find(r => r.id === selectedRewardId);
                            if (reward) {
                                const pointsChange = reward.type === 'gain' ? reward.cost : -reward.cost;
                                pointsAwarded = pointsChange;
                                afterPoints += pointsChange;
                                batch.update(userRef, { points: increment(pointsChange) });
                                await this.addPointLog(userId, `Admin award: ${reward.name}`, pointsChange, batch);
                                await this.logAction('ADMIN_AWARD_REWARD', `Awarded reward "${reward.name}" to ${userData.firstName} ${userData.lastName}.`, { before: beforePoints, after: afterPoints });
                            }
                        }

                        if (selectedBadgeId) {
                            const badge = this.state.badges.find(b => b.id === selectedBadgeId);
                            if (badge && !(userData.earnedBadgeIds || []).includes(selectedBadgeId)) {
                                badgeAwarded = badge.name;
                                await this.awardBadge(userId, selectedBadgeId, batch); // awardBadge now handles logging
                            }
                        }

                        await batch.commit();

                        let successMessage = `Awarded to ${userData.firstName}!`;
                        if (pointsAwarded !== 0) successMessage += `\n${pointsAwarded > 0 ? '+' : ''}${pointsAwarded} points.`;
                        if (badgeAwarded) successMessage += `\nBadge: ${badgeAwarded}.`;

                        this.showModal('success', 'Award Successful', successMessage);
                        statusEl.textContent = 'Success!';
                        this.checkAndAwardBadges(userId);

                    } catch (error) {
                        this.showModal('error', 'Error', `Failed to award user. ${error.message}`);
                        statusEl.textContent = 'Error!';
                    } finally {
                        startBtn.innerHTML = '<i data-lucide="camera"></i><span>Start Scan</span>';
                        lucide.createIcons();
                    }
                };

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                this.state.html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                    .then(() => {
                        startBtn.innerHTML = '<i data-lucide="camera-off"></i><span>Stop Scan</span>';
                        lucide.createIcons();
                        statusEl.textContent = 'Scanner is active.';
                    })
                    .catch(err => {
                        statusEl.textContent = 'Camera permission denied.';
                    });
            };
            this.handleDirectorySearch = () => { this.state.directorySearch = document.getElementById('directory-search-input').value.toLowerCase(); this.render(); };
            this.handleAdminSearch = (type, term) => { const lowercasedTerm = term.toLowerCase(); if (type === 'member') this.state.adminMemberSearch = lowercasedTerm; if (type === 'reward') this.state.adminRewardSearch = lowercasedTerm; this.render(); 

            };
            // (This goes after the handleAdminSearch function around line 2146)

            this.handleAdminRewardSearch = () => {
                const searchTerm = document.getElementById('admin-reward-search-input').value;
                this.handleAdminSearch('reward', searchTerm);
            };

            this.showAllRewards = () => {
                document.getElementById('admin-reward-search-input').value = ''; // Clear the input
                this.handleAdminSearch('reward', ''); // Search with an empty string
            };
            this.handleCreateEvent = async (e) => { e.preventDefault(); const name = e.target.elements.eventName.value; const date = e.target.elements.eventDate.value; const description = e.target.elements.eventDescription.value; const points = parseInt(e.target.elements.eventPoints.value); const badgeId = e.target.elements.badgeId.value; const isVisible = e.target.elements.isVisible.checked; if (name && points && date) { await addDoc(collection(this.fb.db, this.paths.events), { name, description, points, badgeId: badgeId || null, isVisible, timestamp: Timestamp.fromDate(new Date(date)) }); await this.logAction('ADMIN_CREATE_EVENT', `Created event: "${name}".`); e.target.reset(); this.state.adminActiveTab = 'events'; } else { this.showModal('error', 'Invalid Input', 'Provide a valid event name, date, and points.'); } };
            this.handleCreateReward = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const name = formData.get('rewardName');
                const cost = parseInt(formData.get('rewardCost'));
                const type = formData.get('rewardType');
                const badgeId = formData.get('badgeId');
                const claimType = formData.get('claimType');
                const claimLimitType = formData.get('claimLimitType');
                const claimLimit = claimLimitType === 'limited' ? parseInt(formData.get('claimLimit')) : null;
                const isVisible = formData.get('isVisible') === 'on';

                let schedules = [];
                if (claimType === 'scheduled') {
                    const dateInputs = document.querySelectorAll('input[name="scheduleDate"]');
                    const startInputs = document.querySelectorAll('input[name="scheduleStart"]');
                    const endInputs = document.querySelectorAll('input[name="scheduleEnd"]');
                    for (let i = 0; i < dateInputs.length; i++) {
                        if (dateInputs[i].value && startInputs[i].value && endInputs[i].value) {
                            schedules.push({
                                startDate: `${dateInputs[i].value}T${startInputs[i].value}`,
                                endDate: `${dateInputs[i].value}T${endInputs[i].value}`,
                            });
                        }
                    }
                }

                const dailySchedule = {};
                if (claimType === 'daily') {
                    const days = [];
                    document.querySelectorAll('input[name^="day_"]:checked').forEach(cb => {
                        days.push(parseInt(cb.value));
                    });

                    const times = [];
                    const startInputs = document.querySelectorAll('input[name="dailyStart"]');
                    const endInputs = document.querySelectorAll('input[name="dailyEnd"]');
                    for (let i = 0; i < startInputs.length; i++) {
                        if (startInputs[i].value && endInputs[i].value) {
                            times.push({
                                start: startInputs[i].value,
                                end: endInputs[i].value,
                            });
                        }
                    }
                    dailySchedule.days = days;
                    dailySchedule.times = times;
                }


                const newReward = {
                    name, cost, type, badgeId, isVisible,
                    claimType, claimLimitType,
                    claimLimit: claimLimit,
                    claimsLeft: claimLimit, // Initialize claimsLeft
                    schedules,
                    dailySchedule: claimType === 'daily' ? dailySchedule : null,
                };

                await addDoc(collection(this.fb.db, this.paths.rewards), newReward);
                await this.logAction('ADMIN_CREATE_REWARD', `Created reward: "${name}".`);
                e.target.reset();
                this.state.adminActiveTab = 'rewards';
            };
            this.handleCreateAnnouncement = async (e) => { e.preventDefault(); const message = e.target.elements.announcementMessage.value; if (message) { await addDoc(collection(this.fb.db, this.paths.announcements), { message, timestamp: new Date().toLocaleString() }); e.target.reset(); this.state.adminActiveTab = 'announcements'; } };
            this.handleDeleteAnnouncement = async (id) => { await deleteDoc(doc(this.fb.db, this.paths.announcements, id)); };
            this.handleCreateBadge = async (e) => { e.preventDefault(); const formData = new FormData(e.target); const iconSelect = formData.get('badgeIconSelect'); const iconText = formData.get('badgeIconText').trim(); const iconUrl = formData.get('badgeIconUrl').trim(); const icon = iconUrl || iconText || iconSelect; const criteriaValue = formData.get('badgeCriteriaValue'); const newBadge = { name: formData.get('badgeName'), description: formData.get('badgeDescription'), icon: icon, criteria: { type: formData.get('badgeCriteriaType'), value: criteriaValue ? parseInt(criteriaValue) : 0 }, isVisible: formData.get('isVisible') === 'on' }; if (newBadge.name && newBadge.icon) { await addDoc(collection(this.fb.db, this.paths.badges), newBadge); await this.logAction('ADMIN_CREATE_BADGE', `Created badge: "${newBadge.name}".`); e.target.reset(); this.state.adminActiveTab = 'badges'; } else { this.showModal('error', 'Invalid Input', 'Please provide at least a Badge Name and an Icon.'); } };
            this.handleDeleteBadge = async (badgeId) => { const badge = this.state.badges.find(b => b.id === badgeId); if (!badge) return; this.showModal('confirm', 'Delete Badge?', `Are you sure you want to delete this badge? This cannot be undone.`, async () => { await deleteDoc(doc(this.fb.db, this.paths.badgeDoc(badgeId))); await this.logAction('ADMIN_DELETE_BADGE', `Deleted badge: "${badge.name}".`); this.state.adminActiveTab = 'badges'; }); };
            this.handleAdminUpdateUser = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const userId = formData.get('userId');
                const user = this.state.users.find(u => u.id === userId);
                if (user) {
                    const beforePoints = user.points;
                    const afterPoints = parseInt(formData.get('points'), 10);
                    const updatedData = {
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        skills: formData.get('skills'),
                        points: afterPoints,
                        isValidated: formData.get('isValidated') === 'on'
                    };
                    await updateDoc(doc(this.fb.db, this.paths.userDoc(userId)), updatedData);
                    await this.logAction('ADMIN_UPDATE_USER', `Updated profile for ${user.firstName} ${user.lastName}.`, { before: beforePoints, after: afterPoints });
                    this.closeFullscreenModal();
                    this.showModal('success', 'Member Updated', `${user.firstName}'s profile was updated.`);
                    this.state.adminActiveTab = 'members';
                }
            };
            this.handleAdminApproveUser = async (userId) => { const user = this.state.users.find(u => u.id === userId); if (!user) return; await updateDoc(doc(this.fb.db, this.paths.userDoc(userId)), { isValidated: true, validatedAt: new Date().toLocaleDateString() }); await this.logAction('ADMIN_APPROVE_USER', `Approved user: ${user.firstName} ${user.lastName}.`); this.showModal('success', 'User Approved', 'The member now has full access.'); this.state.adminActiveTab = 'verification'; };
            this.handleAdminUpdateEvent = async (e) => { e.preventDefault(); const formData = new FormData(e.target); const eventId = formData.get('eventId'); const eventName = formData.get('eventName'); await updateDoc(doc(this.fb.db, this.paths.eventDoc(eventId)), { name: eventName, description: formData.get('eventDescription'), points: parseInt(formData.get('eventPoints'), 10), badgeId: formData.get('badgeId') || null, isVisible: formData.get('isVisible') === 'on', timestamp: Timestamp.fromDate(new Date(formData.get('eventDate'))) }); await this.logAction('ADMIN_UPDATE_EVENT', `Updated event: "${eventName}".`); this.closeFullscreenModal(); this.showModal('success', 'Event Updated', 'The event details have been saved.'); this.state.adminActiveTab = 'events'; };
            this.handleAdminDeleteEvent = async (eventId) => { const event = this.state.events.find(e => e.id === eventId); if (!event) return; this.showModal('confirm', 'Delete Event?', 'This will permanently delete the event and its QR code. This cannot be undone.', async () => { await deleteDoc(doc(this.fb.db, this.paths.eventDoc(eventId))); await this.logAction('ADMIN_DELETE_EVENT', `Deleted event: "${event.name}".`); this.closeFullscreenModal(); this.showModal('success', 'Event Deleted', 'The event has been removed.'); this.state.adminActiveTab = 'events'; }); };
            this.handleAdminUpdateReward = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const rewardId = this.state.adminEditingRewardId;
                if (!rewardId) return;

                const rewardName = formData.get('rewardName');
                const cost = parseInt(formData.get('rewardCost'));
                const type = formData.get('rewardType');
                const badgeId = formData.get('badgeId');
                const claimType = formData.get('claimType');
                const claimLimitType = formData.get('claimLimitType');
                const claimLimit = claimLimitType === 'limited' ? parseInt(formData.get('claimLimit')) : null;
                const isVisible = formData.get('isVisible') === 'on';

                let schedules = [];
                if (claimType === 'scheduled') {
                    const dateInputs = document.querySelectorAll('input[name="scheduleDate"]');
                    const startInputs = document.querySelectorAll('input[name="scheduleStart"]');
                    const endInputs = document.querySelectorAll('input[name="scheduleEnd"]');
                    for (let i = 0; i < dateInputs.length; i++) {
                        if (dateInputs[i].value && startInputs[i].value && endInputs[i].value) {
                            schedules.push({
                                startDate: `${dateInputs[i].value}T${startInputs[i].value}`,
                                endDate: `${dateInputs[i].value}T${endInputs[i].value}`,
                            });
                        }
                    }
                }

                const dailySchedule = {};
                if (claimType === 'daily') {
                    const days = [];
                    document.querySelectorAll('input[name^="day_"]:checked').forEach(cb => {
                        days.push(parseInt(cb.value));
                    });

                    const times = [];
                    const startInputs = document.querySelectorAll('input[name="dailyStart"]');
                    const endInputs = document.querySelectorAll('input[name="dailyEnd"]');
                    for (let i = 0; i < startInputs.length; i++) {
                        if (startInputs[i].value && endInputs[i].value) {
                            times.push({
                                start: startInputs[i].value,
                                end: endInputs[i].value,
                            });
                        }
                    }
                    dailySchedule.days = days;
                    dailySchedule.times = times;
                }

                const updatedData = {
                    name: rewardName,
                    cost,
                    type,
                    badgeId: badgeId || null,
                    isVisible,
                    claimType,
                    claimLimitType,
                    claimLimit,
                    claimsLeft: claimLimit,
                    schedules,
                    dailySchedule: claimType === 'daily' ? dailySchedule : null,
                };

                await updateDoc(doc(this.fb.db, this.paths.rewardDoc(rewardId)), updatedData);
                await this.logAction('ADMIN_UPDATE_REWARD', `Updated reward: "${rewardName}".`);
                this.cancelEditRewardMode(); // Go back to 'add' mode
                this.showModal('success', 'Reward Updated', 'The reward details have been saved.');
            };
            this.handleAdminUpdateBadge = async (e) => { e.preventDefault(); const formData = new FormData(e.target); const badgeId = formData.get('badgeId'); const badgeName = formData.get('badgeName'); const iconSelect = formData.get('badgeIconSelect'); const iconText = formData.get('badgeIconText').trim(); const iconUrl = formData.get('badgeIconUrl').trim(); const icon = iconUrl || iconText || iconSelect; const criteriaValue = formData.get('badgeCriteriaValue'); const updatedBadge = { name: badgeName, description: formData.get('badgeDescription'), icon: icon, criteria: { type: formData.get('badgeCriteriaType'), value: criteriaValue ? parseInt(criteriaValue) : 0 }, isVisible: formData.get('isVisible') === 'on' }; if (updatedBadge.name && updatedBadge.icon) { await updateDoc(doc(this.fb.db, this.paths.badgeDoc(badgeId)), updatedBadge); await this.logAction('ADMIN_UPDATE_BADGE', `Updated badge: "${badgeName}".`); this.closeFullscreenModal(); this.showModal('success', 'Badge Updated', 'The badge has been saved.'); this.state.adminActiveTab = 'badges'; } else { this.showModal('error', 'Invalid Input', 'Please provide at least a Badge Name and an Icon.'); } };
            this.handleAdminDeleteUser = (userId) => { const user = this.state.users.find(u => u.id === userId); if (!user) return; this.showModal('confirm', 'Delete User?', `Are you sure you want to delete ${user.firstName} ${user.lastName}? This will only remove their data, not their login.`, async () => { await deleteDoc(doc(this.fb.db, this.paths.userDoc(userId))); await this.logAction('ADMIN_DELETE_USER', `Deleted user: ${user.firstName} ${user.lastName} (${user.email}).`); this.closeFullscreenModal(); this.showModal('success', 'User Deleted', `${user.firstName}'s data has been removed.`); this.state.adminActiveTab = 'members'; }); };
            this.handleAdminPasswordReset = (email) => { this.showModal('confirm', 'Send Password Reset?', `This will send a password reset link to ${email}.`, async () => { try { await sendPasswordResetEmail(this.fb.auth, email); this.showModal('success', 'Email Sent', `A password reset link has been sent to ${email}.`); } catch (error) { this.showModal('error', 'Failed to Send', error.message); } }); };
            this.handleAdminDeleteReward = (rewardId) => { const reward = this.state.rewards.find(r => r.id === rewardId); if (!reward) return; this.showModal('confirm', 'Delete Reward?', `Are you sure you want to delete "${reward.name}"?`, async () => { await deleteDoc(doc(this.fb.db, this.paths.rewards, rewardId)); await this.logAction('ADMIN_DELETE_REWARD', `Deleted reward: "${reward.name}".`); this.state.adminActiveTab = 'rewards'; }); };
            this.handleAdminAddMember = async (e) => { e.preventDefault(); const formData = new FormData(e.target); const newUser = Object.fromEntries(formData.entries()); try { const userCredential = await createUserWithEmailAndPassword(this.fb.auth, newUser.email, newUser.password); const user = userCredential.user; const userProfile = { email: newUser.email, firstName: newUser.firstName, lastName: newUser.lastName, skills: newUser.skills || '', points: parseInt(newUser.points, 10) || 0, profilePic: `https://placehold.co/400x400/F59E0B/FFFFFF?text=${newUser.firstName.charAt(0)}`, memberSince: new Date().toLocaleDateString(), isPublic: false, isValidated: true, validatedAt: new Date().toLocaleDateString(), earnedBadgeIds: [] }; await setDoc(doc(this.fb.db, this.paths.userDoc(user.uid)), userProfile); await this.logAction('ADMIN_CREATE_USER', `Created and validated new user: ${newUser.email}.`); await this.addPointLog(user.uid, 'Account Created by Admin', userProfile.points); this.closeFullscreenModal(); this.showModal('success', 'Member Added', `Account for ${newUser.firstName} has been created.`); this.state.adminActiveTab = 'members'; } catch (error) { this.showModal('error', 'Creation Failed', error.message); } };

            // --- GAMIFICATION & THEME ---
            this.handleThemeChange = async (theme) => {
                this.applyTheme(theme);
                await updateDoc(doc(this.fb.db, this.paths.userDoc(this.state.firebaseUser.uid)), { theme });
            };
            this.applyTheme = (theme) => {
                document.body.className = `bg-gray-900 text-white antialiased theme-${theme || 'default'}`;
            };
            this.awardBadge = async (userId, badgeId, batch) => {
                const badge = this.state.badges.find(b => b.id === badgeId);
                const user = this.state.users.find(u => u.id === userId);
                if (!badge || !user) return;

                const earnedBadgeRef = doc(this.fb.db, this.paths.earnedBadges(userId), badgeId);
                const userRef = doc(this.fb.db, this.paths.userDoc(userId));

                const data = { badgeId: badge.id, earnedAt: new Date().toLocaleString() };
                const logDetails = `User ${user.firstName} ${user.lastName} earned badge: "${badge.name}".`;

                if (batch) {
                    batch.set(earnedBadgeRef, data);
                    batch.update(userRef, { earnedBadgeIds: arrayUnion(badgeId) });
                } else {
                    const localBatch = writeBatch(this.fb.db);
                    localBatch.set(earnedBadgeRef, data);
                    localBatch.update(userRef, { earnedBadgeIds: arrayUnion(badgeId) });
                    await localBatch.commit();
                }

                // Log this action
                await this.logAction('BADGE_EARNED', logDetails);

                setTimeout(() => {
                    this.showModal('success', 'Achievement Unlocked!', `You've earned the "${badge.name}" badge!`);
                }, 1500);
            };
            this.handleAdminManageBadge = async (userId, badgeId) => {
                const user = this.state.users.find(u => u.id === userId);
                const badge = this.state.badges.find(b => b.id === badgeId);
                if (!user || !badge) return;
                const userRef = doc(this.fb.db, this.paths.userDoc(userId));
                const earnedBadgeRef = doc(this.fb.db, this.paths.earnedBadges(userId), badgeId);

                if ((user.earnedBadgeIds || []).includes(badgeId)) {
                    // Revoke badge
                    await updateDoc(userRef, { earnedBadgeIds: arrayRemove(badgeId) });
                    await deleteDoc(earnedBadgeRef);
                    await this.logAction('ADMIN_REVOKE_BADGE', `Revoked badge "${badge.name}" from ${user.firstName} ${user.lastName}.`);
                } else {
                    // Grant badge
                    await updateDoc(userRef, { earnedBadgeIds: arrayUnion(badgeId) });
                    await setDoc(earnedBadgeRef, { badgeId: badgeId, earnedAt: new Date().toLocaleString() });
                    await this.logAction('ADMIN_GRANT_BADGE', `Granted badge "${badge.name}" to ${user.firstName} ${user.lastName}.`);
                }
                this.openUserEditModal(userId); // Refresh the modal
            };
            this.checkAndAwardBadges = async (userId) => {
                const user = this.state.users.find(u => u.id === userId);
                if (!user) return;

                const userCheckIns = await getDocs(query(collection(this.fb.db, this.paths.checkIns), where("userId", "==", userId)));
                const eventsAttended = userCheckIns.size;

                for (const badge of this.state.badges) {
                    const alreadyEarned = (user.earnedBadgeIds || []).includes(badge.id);
                    if (alreadyEarned) continue;

                    let criteriaMet = false;
                    if (badge.criteria.type === 'points' && user.points >= badge.criteria.value) {
                        criteriaMet = true;
                    } else if (badge.criteria.type === 'events' && eventsAttended >= badge.criteria.value) {
                        criteriaMet = true;
                    }

                    if (criteriaMet) {
                        await this.awardBadge(userId, badge.id);
                    }
                }
            };

            // --- MODAL & UI LOGIC ---
            this.addDailyTimeRow = (start = '', end = '') => {
                const container = document.getElementById('daily-times-container');
                if (!container) return; // FIX: Add a guard clause
                const row = document.createElement('div');
                row.className = 'flex items-center space-x-2';
                row.innerHTML = `
                    <input type="time" name="dailyStart" class="w-full bg-gray-600 rounded-lg p-2 text-sm" value="${start}">
                    <span class="text-gray-400">-</span>
                    <input type="time" name="dailyEnd" class="w-full bg-gray-600 rounded-lg p-2 text-sm" value="${end}">
                    <button type="button" onclick="this.parentElement.remove()" class="p-2 bg-red-500/20 text-red-400 rounded-md"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                container.appendChild(row);
                lucide.createIcons();
            };
            this.addScheduleRow = (date = '', start = '', end = '') => {
                const container = document.getElementById('scheduled-dates-container');
                if (!container) return; // FIX: Add a guard clause
                const row = document.createElement('div');
                row.className = 'flex items-center space-x-2';
                row.innerHTML = `
                    <input type="date" name="scheduleDate" class="w-full bg-gray-600 rounded-lg p-2 text-sm" value="${date}">
                    <input type="time" name="scheduleStart" class="w-full bg-gray-600 rounded-lg p-2 text-sm" value="${start}">
                    <input type="time" name="scheduleEnd" class="w-full bg-gray-600 rounded-lg p-2 text-sm" value="${end}">
                    <button type="button" onclick="this.parentElement.remove()" class="p-2 bg-red-500/20 text-red-400 rounded-md"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                container.appendChild(row);
                lucide.createIcons();
            };
            this.renderBadgeIcon = (icon, classes) => {
                if (!icon) return '';
                if (icon.startsWith('http')) {
                    return `<img src="${icon}" class="${classes} object-cover">`;
                }
                return `<i data-lucide="${icon}" class="${classes}"></i>`;
            };
            this.getIconOptions = () => {
                const icons = ['award', 'badge-check', 'bone', 'bot', 'box', 'briefcase', 'cake', 'camera', 'car', 'cat', 'check-circle-2', 'chef-hat', 'cherry', 'church', 'clap', 'clover', 'coffee', 'compass', 'computer', 'construction', 'contact', 'cookie', 'crown', 'cup-soda', 'diamond', 'dice-5', 'disc', 'dog', 'dollar-sign', 'donut', 'drama', 'dribbble', 'droplet', 'dumbbell', 'egg-fried', 'feather', 'figma', 'film', 'fish', 'flag', 'flame', 'flask-conical', 'flower-2', 'folder', 'footprints', 'gamepad-2', 'gem', 'ghost', 'gift', 'git-branch', 'github', 'gitlab', 'glass-water', 'glasses', 'globe', 'grape', 'guitar', 'hammer', 'hand', 'hand-heart', 'hand-metal', 'hard-hat', 'heart', 'heart-pulse', 'hexagon', 'home', 'ice-cream', 'key', 'keyboard', 'lamp', 'laptop', 'leaf', 'lightbulb', 'linkedin', 'map', 'medal', 'megaphone', 'mic', 'moon', 'mouse-pointer-2', 'music', 'palette', 'party-popper', 'pencil', 'pizza', 'plane', 'plug', 'puzzle', 'rocket', 'save', 'school', 'scissors', 'shield', 'skull', 'slack', 'smartphone', 'sprout', 'star', 'sun', 'swords', 'trello', 'trophy', 'twitter', 'umbrella', 'university', 'video', 'wallet', 'wand', 'watch', 'waves', 'wind', 'wrench', 'youtube', 'zap'];
                return `<option value="">No Icon (Use Name)</option>` + icons.map(icon => `<option value="${icon}">${icon.charAt(0).toUpperCase() + icon.slice(1).replace('-', ' ')}</option>`).join('');
            };
            this.openFullscreenModal = (title, content) => { this.elements.fullscreenModalTitle.textContent = title; this.elements.fullscreenModalContent.innerHTML = content; this.elements.fullscreenModal.classList.remove('hidden'); lucide.createIcons(); };
            this.closeFullscreenModal = () => this.elements.fullscreenModal.classList.add('hidden');
            this.openMemberQrModal = () => {
                const user = this.state.loggedInUser;
                if (!user) return;
                const content = `
                    <div class="text-center">
                        <p class="mb-4 text-lg font-semibold">${user.firstName} ${user.lastName}</p>
                        <div class="bg-white p-4 rounded-xl max-w-xs mx-auto">
                            <canvas id="modal-member-qr"></canvas>
                        </div>
                        <p class="mt-4 text-gray-400">Present this code for event check-ins and rewards.</p>
                    </div>
                `;
                this.openFullscreenModal(`My Pride Pass`, content);
                this.generateQRCode('modal-member-qr', JSON.stringify({ type: 'member', id: user.id }), 256);
            };
            this.openMemberDetailsModal = (userId) => { const user = this.state.users.find(u => u.id === userId); if (!user) return; const earnedBadges = (user.earnedBadgeIds || []).map(badgeId => this.state.badges.find(b => b.id === badgeId)).filter(Boolean); const content = `<div class="text-center space-y-4"><img src="${user.profilePic}" class="w-32 h-32 rounded-full mx-auto object-cover border-4 border-purple-500"><h2 class="text-2xl font-bold">${user.firstName} ${user.lastName}</h2><p class="text-gray-400">${user.skills || 'No skills listed'}</p><p class="text-gray-300 font-semibold">${user.contact}</p><div class="mt-4 border-t border-gray-600 pt-4"><h4 class="font-semibold text-center mb-2">Earned Badges</h4><div class="grid grid-cols-3 sm:grid-cols-4 gap-4">${earnedBadges.length > 0 ? earnedBadges.map(badge => `<div class="text-center p-2 bg-gray-700 rounded-lg">${this.renderBadgeIcon(badge.icon, 'w-10 h-10 mx-auto text-amber-400')}<p class="text-xs mt-2 font-semibold">${badge.name}</p></div>`).join('') : '<p class="text-gray-400 col-span-full">No badges earned yet.</p>'}</div></div></div>`; this.openFullscreenModal(`Member Details`, content); };
            this.openUserEditModal = (userId) => { const user = this.state.users.find(u => u.id === userId); if (!user) return; const content = `<form id="admin-edit-user-form" class="space-y-4"><input type="hidden" name="userId" value="${user.id}"><div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">First Name</label><input name="firstName" value="${user.firstName}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div><label class="text-sm text-gray-400">Last Name</label><input name="lastName" value="${user.lastName}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div></div><div><label class="text-sm text-gray-400">Skills</label><input name="skills" value="${user.skills}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div><label class="text-sm text-gray-400">Points</label><input name="points" type="number" value="${user.points}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div class="bg-gray-900/50 p-4 rounded-lg flex justify-between items-center"><label for="is-validated" class="font-semibold">Validated Member</label><input type="checkbox" id="is-validated" name="isValidated" ${user.isValidated ? 'checked' : ''} class="h-6 w-6 rounded-md accent-pink-500"></div><p class="text-xs text-gray-400 text-center">Validated on: ${user.validatedAt || 'N/A'}</p><button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold mt-4">Save Changes</button><div class="flex space-x-2"><button type="button" onclick="app.handleAdminPasswordReset('${user.email}')" class="w-full bg-blue-500/20 text-blue-400 py-3 rounded-lg font-semibold mt-2">Send Password Reset</button><button type="button" onclick="app.handleAdminDeleteUser('${user.id}')" class="w-full bg-red-500/20 text-red-400 py-3 rounded-lg font-semibold mt-2">Delete User</button></div><div class="mt-4 border-t border-gray-600 pt-4"><h4 class="font-semibold text-center mb-2">Manage Badges</h4><div class="space-y-2">${this.state.badges.map(badge => { const hasBadge = (user.earnedBadgeIds || []).includes(badge.id); return `<div class="flex items-center justify-between bg-gray-700 p-2 rounded-lg"> <div class="flex items-center space-x-2"> ${this.renderBadgeIcon(badge.icon, 'w-5 h-5 text-amber-400')} <p>${badge.name}</p> </div> <button type="button" onclick="app.handleAdminManageBadge('${user.id}', '${badge.id}')" class="px-3 py-1 text-xs font-semibold rounded-md ${hasBadge ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">${hasBadge ? 'Revoke' : 'Grant'}</button> </div>` }).join('')}</div></div></form>`; this.openFullscreenModal(`Edit ${user.firstName}'s Profile`, content); document.getElementById('admin-edit-user-form').addEventListener('submit', this.handleAdminUpdateUser.bind(this)); };
            this.openAddMemberModal = () => { const content = `<form id="admin-add-user-form" class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">First Name*</label><input name="firstName" required class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div><label class="text-sm text-gray-400">Last Name*</label><input name="lastName" required class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div></div><div><label class="text-sm text-gray-400">Email*</label><input name="email" type="email" required class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div><label class="text-sm text-gray-400">Password*</label><input name="password" required class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div><label class="text-sm text-gray-400">Skills</label><input name="skills" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div><label class="text-sm text-gray-400">Starting Points</label><input name="points" type="number" value="0" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold mt-4">Create Account</button></form>`; this.openFullscreenModal('Add New Member', content); document.getElementById('admin-add-user-form').addEventListener('submit', this.handleAdminAddMember.bind(this)); };

            this.openBadgeEditModal = (badgeId) => { const badge = this.state.badges.find(b => b.id === badgeId); if (!badge) return; const content = `<form id="admin-edit-badge-form" class="space-y-4"><input type="hidden" name="badgeId" value="${badge.id}"><input name="badgeName" value="${badge.name}" type="text" placeholder="Badge Name" required class="w-full bg-gray-700 rounded-lg p-3"><input name="badgeDescription" value="${badge.description}" type="text" placeholder="Description" required class="w-full bg-gray-700 rounded-lg p-3"><div x-data="{ method: 'select' }"><label class="text-sm text-gray-400">Icon</label><div class="flex space-x-2 p-1 bg-gray-800 rounded-lg my-1"><button type="button" @click="method = 'select'" :class="{ 'pride-gradient-bg text-white': method === 'select', 'bg-gray-700': method !== 'select' }" class="flex-1 py-1 rounded-md text-sm">Select from List</button><button type="button" @click="method = 'text'" :class="{ 'pride-gradient-bg text-white': method === 'text', 'bg-gray-700': method !== 'text' }" class="flex-1 py-1 rounded-md text-sm">Type Name</button><button type="button" @click="method = 'url'" :class="{ 'pride-gradient-bg text-white': method === 'url', 'bg-gray-700': method !== 'url' }" class="flex-1 py-1 rounded-md text-sm">Use URL</button></div><div x-show="method === 'select'"><div class="flex items-center space-x-2"><select name="badgeIconSelect" class="w-full bg-gray-700 rounded-lg p-3">${this.getIconOptions()}</select></div></div><div x-show="method === 'text'" style="display: none;"><input name="badgeIconText" value="${badge.icon.startsWith('http') ? '' : badge.icon}" type="text" placeholder="e.g., 'rocket', 'award'" class="w-full bg-gray-700 rounded-lg p-3"></div><div x-show="method === 'url'" style="display: none;"><input name="badgeIconUrl" value="${badge.icon.startsWith('http') ? badge.icon : ''}" type="url" placeholder="https://example.com/icon.png" class="w-full bg-gray-700 rounded-lg p-3"></div></div><div x-data="{ criteria: '${badge.criteria.type}' }"><label class="text-sm text-gray-400">Criteria</label><select name="badgeCriteriaType" @change="criteria = $event.target.value" class="w-full bg-gray-700 rounded-lg p-3 mt-1"><option value="special" ${badge.criteria.type === 'special' ? 'selected' : ''}>Special (Admin Awarded)</option><option value="points" ${badge.criteria.type === 'points' ? 'selected' : ''}>Points Earned</option><option value="events" ${badge.criteria.type === 'events' ? 'selected' : ''}>Events Attended</option></select><div x-show="criteria !== 'special'"><input name="badgeCriteriaValue" value="${badge.criteria.value || ''}" type="number" placeholder="Value (e.g., 500)" class="w-full bg-gray-700 rounded-lg p-3 mt-2"></div></div><div class="flex items-center space-x-2"><input type="checkbox" id="badge-visible-edit" name="isVisible" ${badge.isVisible ? 'checked' : ''} class="h-5 w-5 rounded accent-pink-500"><label for="badge-visible-edit">Visible to Members</label></div><button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold">Save Changes</button></form>`; this.openFullscreenModal(`Edit Badge: ${badge.name}`, content); document.getElementById('admin-edit-badge-form').addEventListener('submit', this.handleAdminUpdateBadge.bind(this)); };
            this.openRewardQrModal = (rewardId) => { const reward = this.state.rewards.find(r => r.id === rewardId); if (!reward) return; const content = `<div class="text-center"><p class="mb-4 text-lg font-semibold">${reward.name}</p><div class="bg-white p-4 rounded-xl max-w-xs mx-auto"><canvas id="modal-reward-qr"></canvas></div><p class="mt-4 text-gray-400">Scan this code to ${reward.type === 'cost' ? `redeem for ${reward.cost} points` : `gain ${reward.cost} points`}.</p></div>`; this.openFullscreenModal(`Reward QR Code`, content); this.generateQRCode('modal-reward-qr', JSON.stringify({ type: 'reward', id: reward.id }), 256); };
            // (Line 2417)
            this.openPointsLogModal = () => {
                const logs = this.state.pointLogs;
                const content = `<div class="space-y-3">${logs.map(log =>
                    `<div class="bg-gray-700 p-3 rounded-lg">
            <div class="flex justify-between items-center">
                <p>${log.description}</p>
                <p class="font-bold ${log.points >= 0 ? 'text-green-400' : 'text-red-400'}">
                    ${log.points >= 0 ? '+' : ''}${log.points} PTS
                </p>
            </div>
            ${(log.beforePoints !== undefined && log.afterPoints !== undefined) ?
                        `<p class="text-xs text-gray-400">Points: ${log.beforePoints} â†’ ${log.afterPoints}</p>` : ''
                    }
            <p class="text-xs text-gray-400 mt-1">${log.timestamp}</p>
        </div>`
                ).join('') || '<p class="text-center text-gray-400">No transactions yet.</p>'}</div>`;
                this.openFullscreenModal('Points History', content);
            };
            this.openEventDetailsModal = async (eventId) => { const event = this.state.events.find(e => e.id === eventId); if (!event) return; const checkInsCollection = collection(this.fb.db, this.paths.checkIns); const q = query(checkInsCollection, where("eventId", "==", eventId)); const snapshot = await getDocs(q); const attendees = []; for (const doc of snapshot.docs) { const checkInData = doc.data(); const user = this.state.users.find(u => u.id === checkInData.userId); if (user) attendees.push({ user, timestamp: checkInData.timestamp }); } const eventDate = event.timestamp ? new Date(event.timestamp.seconds * 1000).toISOString().slice(0, 16) : ''; const content = `<div x-data="{ tab: 'details' }"><div class="flex space-x-2 mb-4 bg-gray-900 rounded-lg p-1"><button @click="tab = 'details'" :class="{ 'bg-gray-700': tab === 'details' }" class="flex-1 py-2 rounded-md font-semibold text-sm">Details & QR</button><button @click="tab = 'attendees'" :class="{ 'bg-gray-700': tab === 'attendees' }" class="flex-1 py-2 rounded-md font-semibold text-sm">Attendees (${attendees.length})</button></div><div x-show="tab === 'details'"><form id="admin-edit-event-form" class="space-y-4 mb-6"><input type="hidden" name="eventId" value="${event.id}"><div><label class="text-sm text-gray-400">Event Name</label><input name="eventName" value="${event.name}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div><label class="text-sm text-gray-400">Event Date & Time</label><input name="eventDate" type="datetime-local" value="${eventDate}" required class="w-full bg-gray-700 rounded-lg p-3 mt-1 text-white"></div><div><label class="text-sm text-gray-400">Description</label><textarea name="eventDescription" class="w-full bg-gray-700 rounded-lg p-3 h-24">${event.description || ''}</textarea></div><div><label class="text-sm text-gray-400">Points</label><input name="eventPoints" type="number" value="${event.points}" class="w-full bg-gray-700 rounded-lg p-3 mt-1"></div><div><label class="text-sm text-gray-400">Optional Badge Reward</label><select name="badgeId" class="w-full bg-gray-700 rounded-lg p-3 mt-1"><option value="">No Badge for this Event</option>${this.state.badges.map(badge => `<option value="${badge.id}" ${event.badgeId === badge.id ? 'selected' : ''}>${badge.name}</option>`).join('')}</select></div><div class="flex items-center space-x-2"><input type="checkbox" id="event-visible-edit" name="isVisible" ${event.isVisible ? 'checked' : ''} class="h-5 w-5 rounded accent-pink-500"><label for="event-visible-edit">Visible to Members</label></div><button type="submit" class="w-full pride-gradient-bg text-white py-3 rounded-lg font-semibold mt-2">Save Event Changes</button><button type="button" onclick="app.handleAdminDeleteEvent('${event.id}')" class="w-full bg-red-500/20 text-red-400 py-3 rounded-lg font-semibold mt-2">Delete Event</button></form><div class="text-center"><p class="mb-2 font-semibold">Event QR Code</p><div class="bg-white p-2 rounded-xl max-w-xs mx-auto"><canvas id="detail-event-qr"></canvas></div></div></div><div x-show="tab === 'attendees'" style="display: none;"><div class="space-y-2">${attendees.map(a => `<div class="bg-gray-700 p-3 rounded-lg"><div class="flex items-center justify-between"><p class="font-semibold">${a.user.firstName} ${a.user.lastName}</p><p class="text-xs text-gray-400">${a.timestamp}</p></div></div>`).join('') || '<p class="text-center text-gray-400">No one has checked in yet.</p>'}</div></div></div>`; this.openFullscreenModal(`Manage: ${event.name}`, content); this.generateQRCode('detail-event-qr', JSON.stringify({ type: 'event', id: event.id }), 200); document.getElementById('admin-edit-event-form').addEventListener('submit', this.handleAdminUpdateEvent.bind(this)); };
            this.openBadgeDetailsModal = (name, description, icon, earned) => { const content = `<div class="text-center space-y-4"><div class="mx-auto w-32 h-32 flex items-center justify-center">${this.renderBadgeIcon(icon, 'w-24 h-24 ' + (earned ? 'text-amber-400' : 'text-gray-500'))}</div><h2 class="text-2xl font-bold">${name}</h2><p class="text-gray-400">${description}</p><p class="font-bold ${earned ? 'text-green-400' : 'text-red-400'}">${earned ? 'âœ“ Earned' : 'Not Yet Earned'}</p></div>`; this.openFullscreenModal('Badge Details', content); };
            this.showModal = (type, title, message, onConfirm = null) => { const icons = { success: '<svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', error: '<svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', info: '<svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', confirm: '<svg class="w-16 h-16 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>' }; this.elements.modalIcon.innerHTML = icons[type]; this.elements.modalTitle.textContent = title; this.elements.modalMessage.textContent = message; this.elements.modalButtons.innerHTML = ''; if (type === 'confirm') { const confirmBtn = document.createElement('button'); confirmBtn.textContent = 'Confirm'; confirmBtn.className = 'w-full py-3 rounded-lg font-semibold bg-red-500'; confirmBtn.onclick = () => { onConfirm(); this.elements.modal.classList.add('hidden'); }; const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Cancel'; cancelBtn.className = 'w-full py-3 rounded-lg font-semibold bg-gray-600'; cancelBtn.onclick = () => this.elements.modal.classList.add('hidden'); this.elements.modalButtons.appendChild(confirmBtn); this.elements.modalButtons.appendChild(cancelBtn); } else { const closeBtn = document.createElement('button'); closeBtn.textContent = 'Close'; const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' }; closeBtn.className = `w-full py-3 rounded-lg font-semibold ${colors[type]}`; closeBtn.onclick = () => this.elements.modal.classList.add('hidden'); this.elements.modalButtons.appendChild(closeBtn); } this.elements.modal.classList.remove('hidden'); };
        };

        const app = new App();
        window.app = app; // Make app globally accessible for inline event handlers

        // Initialize the main application immediately when the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            // FIX: Use event delegation for forms that might not exist on page load
            app.elements.mainContent.addEventListener('submit', (e) => {
                if (e.target.id === 'login-form') {
                    e.preventDefault();
                    app.handleLogin(e);
                } else if (e.target.id === 'register-form') {
                    e.preventDefault();
                    app.handleRegister(e);
                }
            });

            // Add event delegation for badge clicks
            app.elements.mainContent.addEventListener('click', (e) => {
                const badgeElement = e.target.closest('.badge-item');
                if (badgeElement) {
                    const name = badgeElement.dataset.name;
                    const description = badgeElement.dataset.description;
                    const icon = badgeElement.dataset.icon;
                    const earned = badgeElement.dataset.earned === 'true';
                    app.openBadgeDetailsModal(name, description, icon, earned);
                }
            });
        });
    </script>
</body>

</html>
